var MentionMe=(function(k,g){var q={minLength:3,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1},e={instructions:"type a user name"},o={BACKSPACE:8,NEWLINE:10,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},b=(function(){var M=false,x=false,N=0,ab=null,m=0,B=0,H,O,I=[],P=[],u,v,J,R,Y,Q;function aa(){var af,ae,ad=f.getContainer();v=k("#mentionme_popup");J=k("#mentionme_spinner").hide();R=k("#mentionme_popup_input");Y=k("#mentionme_popup_input_container");Q=k("#mentionme_popup_body");if(typeof ad==="string"&&k("#"+ad).length){u=k("#"+ad)}else{if(typeof ad==="object"&&k(ad).length){u=k(ad)}else{return false}}u.append(v);v.css({left:"-1000px",top:"-1000px"}).show();H=Y.height();af=k("<div/>");if(q.showAvatars){ae=k("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).appendTo(af)}af.append(Array(q.maxLength+1).join("M")).addClass("mentionme_popup_item");Q.html(af);O=parseInt(af.height())+f.lineHeightModifier+parseInt(af.css("paddingTop").replace("px",""))+parseInt(af.css("paddingBottom").replace("px",""));B=Q.width()-Q[0].scrollWidth}function T(ae,ad){if(!a.isReady()&&!a.isLoading()){a.init()}n.init();S();F(ae,ad);v.show();ab=null;W();M=true;Q.mouseover(r);Q.click(L);k(document).click(X);f.bindClick(X);R.keydown(y);R.keyup(z);R.click(C);R.focus()}function X(){v.hide();Q.unbind("mouseover",r);Q.unbind("click",L);k(document).unbind("click",X);f.unBindClick(X);R.unbind("keydown",y);R.unbind("keyup",z);R.unbind("click",C);M=false;R.val("");f.focus()}function F(ah,ag){var af,ae=a.getLongestName(),ad;m=0;if(q.showAvatars){ad=k("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).css({left:"-1000px",top:"-1000px"}).appendTo(u);m+=ad.width();ad.remove()}m+=parseInt(Q.css("fontSize").replace("px","")*ae);af={height:E()+H+"px",width:parseInt(m-B)+"px"};if(typeof ah!="undefined"){af.left=ah+"px"}if(typeof ag!="undefined"){af.top=ag+"px"}v.css(af);Q.css({height:E()+"px",width:m})}function S(){if(!a.isReady()){ac();return}a.match();K();ab=null;W();if(n.getLength()>=q.minLength){a.search()}}function K(){var ae,ag,ad,ai,af=a.getItemsLength(),ah=(navigator.userAgent.toLowerCase().indexOf("msie")!==-1)?"hand":"pointer";I=a.getItems();P=a.getAvatars();if(af===0&&x==false){if(n.getLength()>0){U();Q.html(n.getText())}else{Z()}if(t()){F()}return}U();for(ae=0;ae<af;ae++){ag=I[ae];if(n.getText()){ai=I[ae].toLowerCase().indexOf(n.getText());if((q.fullText&&ai!==-1)||(!q.fullText&&ai===0)){ag=I[ae].slice(0,ai)+'<span class="mention_name_highlight">'+I[ae].slice(ai,ai+n.getText().length)+"</span>"+I[ae].slice(ai+n.getText().length)}}ad="";if(q.showAvatars){if(!P[ae]){P[ae]="images/default_avatar.png"}ad='<img class="mention_user_avatar" src="'+P[ae]+'" />'}Q.append(k("<div/>",{id:"mentionme_popup_item_"+ae,"class":"mentionme_popup_item"}).html(ad+ag).css({cursor:ah}))}if(t()){F()}}function U(){Q.html("");ab=null;x=false;if(t()){F()}}function ac(){U();Q.html(J);x=true;if(t()){F()}}function Z(){U();Q.html('<span style="color: grey; font-style: italic;">'+e.instructions+"</span>")}function z(){if(n.update()){S()}}function W(ad){var ae=a.getItemsLength()-1;switch(ad){case"last":N=ae;break;case"next":N++;if(N>ae){N=0}break;case"previous":N--;if(N<0){N=ae}break;case"nextPage":N+=q.maxItems;if(N>ae){N=ae}break;case"previousPage":N-=q.maxItems;if(N<0){N=0}break;default:N=0;break}s()}function s(ag){if(ab==N||k("#mentionme_popup_item_"+N).length===0){return}var af=k("#mentionme_popup_item_"+N),ae=k("#mentionme_popup_item_"+ab),ad=ae.find("span.mention_name_highlight_on");if(ae.length){ae.removeClass("mentionme_popup_item_on");if(ad.length){ad.removeClass("mention_name_highlight_on");ad.addClass("mention_name_highlight")}}ab=N;if(af){if(!af.hasClass("mentionme_popup_item_on")){af.addClass("mentionme_popup_item_on")}ad=af.find("span.mention_name_highlight");if(ad.length){ad.removeClass("mention_name_highlight");ad.addClass("mention_name_highlight_on")}}if(ag!=true&&(a.getItemsLength()-q.maxItems)>0){Q.prop("scrollTop",parseInt(af.prop("offsetTop")-H))}}function y(ad){switch(ad.keyCode){case o.ENTER:f.insert();break;case o.UP:W("previous");break;case o.DOWN:W("next");break;case o.END:W("last");break;case o.HOME:W();break;case o.PAGE_UP:W("previousPage");break;case o.PAGE_DOWN:W("nextPage");break;case o.ESC:X();break;case o.BACKSPACE:if(R.val()===""){X()}return;break;default:return}ad.preventDefault()}function r(ad){if(G(ad)){s(true)}}function L(ad){if(G(ad)){f.insert()}else{ad.preventDefault()}}function C(ad){ad.stopPropagation()}function G(af){if(!af){return false}var ad,ae=af.target;try{if(!ae||!ae.id||ae.id=="mentionme_popup"||ae.id=="mentionme_spinner"){return false}}catch(af){return false}ad=ae.id.split("_");if(!ad||ad.length==0||!ad[ad.length-1]){return false}N=ad[ad.length-1];return true}function A(){if(a.getItemsLength()===0||!I[N]){return}return I[N]}function E(){return(O*Math.max(1,Math.min(q.maxItems,a.getItemsLength())))+f.heightModifier+4}function V(){return R.val()}function w(){return O}function D(){return x}function t(){return M}return{init:aa,show:T,hide:X,move:F,update:S,buildItems:K,showSpinner:ac,showInstructions:Z,select:W,getSelectedName:A,getCurrentHeight:E,getInputValue:V,getLineHeight:w,spinnerIsVisible:D,isVisible:t}})(),n=(function(){var s="",t="";function u(){s="";t=""}function v(){var w=false,x=b.getInputValue();if(s!==x){w=true}s=x;return w}function r(){return s.length}function m(w){if(w!=true){return s.toLowerCase()}return s}return{init:u,update:v,getLength:r,getText:m}})(),a=(function(){var L={},J={},B={},A=false,s=false,K=false,F=[],E=[],v=[],x=5;function I(){s=true;k.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:q.tid},success:w})}function w(N){A=true;s=false;J=N.inThread;B=N.cached;k.extend(L,J,B);if(L.length===0){L={};b.showInstructions();if(b.isVisible()){b.move()}return}if(b.isVisible()){b.update()}}function t(){var R,P=0,N={},T=[],Q=[],S=[],O=[];E=[];v=[];x=5;for(R in J){if(!D(R,J,N)){continue}if(R.length>x){x=R.length}T.push(J[R]["username"]);if(q.showAvatars){S.push(J[R]["avatar"])}N[R]=true;P++}k.merge(E,T);if(q.showAvatars){k.merge(v,S)}for(R in L){if(!D(R,L,N)){continue}if(R.length>x){x=R.length}Q.push(L[R]["username"]);if(q.showAvatars){O.push(L[R]["avatar"])}N[R]=true;P++}Q=Q.sort(z);k.merge(E,Q);if(q.showAvatars){k.merge(v,O)}return P}function z(O,N){if(O.length<N.length){return -1}else{if(O.length>N.length){return 1}else{return 0}}}function D(P,O,N){if(!O.hasOwnProperty(P)||!O[P]||N[P]||(n.getLength()&&((!q.fullText&&P.slice(0,n.getLength())!==n.getText())||(q.fullText&&P.indexOf(n.getText())===-1)))){return false}return true}function y(){var N=n.getText().slice(0,q.minLength);if(K||F.indexOf(N)!==-1){if(b.spinnerIsVisible()){b.hide()}return}F.push(N);K=true;if(E.length===0){b.showSpinner()}k.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:N},success:u})}function u(O){var P=0,N;K=false;if(!O){if(b.spinnerIsVisible()){b.hide()}return}for(N in O){if(!O.hasOwnProperty(N)||L[N]){continue}L[N]=O[N];P++}if(!P||!b.isVisible()){return}t();b.buildItems();b.select()}function G(){return A}function H(){return s}function m(){return E}function r(){return v}function M(){return E.length}function C(){return x}return{init:I,match:t,search:y,isReady:G,isLoading:H,getItems:m,getAvatars:r,getItemsLength:M,getLongestName:C}})(),j=(function(){var v,A,z={start:0,end:0};function m(){if(k("#message").length==0&&k("#signature").length==0){return false}return true}function B(){var E;if(k("#message").length){E="message"}else{if(k("#signature").length){E="signature"}}if(!E||!k("#"+E).length){return false}v=k("#"+E);A=v.closest("div");b.init();v.keyup(D)}function D(E){t();if(!b.isVisible()){if(c(E.keyCode)&&v.val().slice(z.start-1,z.end)=="@"){y()}}}function y(){var E=v.caret("offset"),G=E.left+3,F=E.top-5;b.show(G,F)}function s(){var E=i();if(!E){if(!b.spinnerIsVisible()){b.hide()}return}t();v.val(v.val().slice(0,z.start)+E+v.val().slice(z.start));r(z.start+E.length);b.hide()}function t(){var E=v.caret("pos");z.start=E;z.end=E}function r(E){var G=v[0],F;if(G.setSelectionRange){G.focus();G.setSelectionRange(E,E)}else{if(G.createTextRange){F=G.createTextRange();F.collapse(true);F.moveEnd("character",E);F.moveStart("character",E);F.select()}}}function w(E){v.click(E)}function u(E){v.unbind("click",E)}function C(){v.focus()}function x(){return A}return{init:B,check:m,heightModifier:0,lineHeightModifier:0,insert:s,bindClick:w,unBindClick:u,focus:C,getContainer:x}})(),l=(function(){var w,t,B={start:0,end:0},D,z,v,E;function m(){if(MyBBEditor===null||typeof MyBBEditor!=="object"||!MyBBEditor.getRangeHelper||typeof MyBBEditor.getRangeHelper!=="function"){return false}return true}function C(){w=MyBBEditor;t=w.getRangeHelper();z=k("iframe");D=z.closest("div");v=w.getBody();w.keyUp(G);b.init()}function G(H){s();if(!H.keyCode){if(H.originalEvent&&H.originalEvent.keyCode){H.keyCode=H.originalEvent.keyCode}else{return}}if(!b.isVisible()){if(c(H.keyCode)&&E.text().slice(B.start-1,B.end)=="@"){A()}return}}function A(){var H=v.caret("offset",{iframe:z[0]}),J=parseInt(H.left)+7,I=parseInt(H.top+D.find("div.sceditor-toolbar").height())+2;b.show(J,I)}function r(){var H=i();if(!H){if(!b.spinnerIsVisible()){b.hide()}return}w.insert(H);b.hide()}function s(){var H=t.selectedRange();if(H.startContainer){E=k(H.startContainer)}else{E=k(w.currentNode())}B.start=H.startOffset;B.end=H.endOffset}function x(H){v.click(H)}function u(H){v.unbind("click",H)}function F(){z.focus()}function y(){return D}return{init:C,check:m,heightModifier:0,lineHeightModifier:0,insert:r,bindClick:x,unBindClick:u,focus:F,getContainer:y}})(),d=(function(){var w,C,A,v,u;function m(){if(typeof CKEDITOR==="undefined"||typeof CKEDITOR.instances==="undefined"||CKEDITOR.instances.length==0){return false}return true}function D(){var G=k.map(CKEDITOR.instances,function(I,H){return H})[0];if(typeof CKEDITOR.instances[G]!=="object"){return false}w=CKEDITOR.instances[G];w.on("instanceReady",z)}function z(){A=k("iframe");C=A.closest("div");v=k(w.document.$);u=v.find("body");v.keyup(F);b.init()}function F(G){if(!b.isVisible()){if(c(G.keyCode)&&t()=="@"){B()}return}}function B(){var G=u.caret("offset",{iframe:A[0]}),J=A.offset(),I=parseInt(G.left+J.left)+2,H=parseInt(G.top+J.top)-5;b.show(I,H)}function r(){var G=i();if(!G){if(!b.spinnerIsVisible()){b.hide()}return}w.insertText(G);b.hide()}function t(){var G=w.getSelection().getRanges()[0],H,I;if(!G||!G.startContainer){return null}H=G.startContainer;if(H.type==CKEDITOR.NODE_TEXT&&G.startOffset){return H.getText()[G.startOffset-1]}else{G.collapse(true);G.setStartAt(w.editable(),CKEDITOR.POSITION_AFTER_START);I=new CKEDITOR.dom.walker(G),node;while((node=I.previous())){if(node.type==CKEDITOR.NODE_TEXT){return node.getText().slice(-1)}}}return null}function x(G){v.click(G)}function s(G){v.unbind("click",G)}function E(){w.focus()}function y(){return C}return{init:D,check:m,heightModifier:0,lineHeightModifier:0,insert:r,bindClick:x,unBindClick:s,focus:E,getContainer:y}})(),f=null;function h(m){k.extend(e,m.lang||{});delete m.lang;k.extend(q,m||{});k(["minLength","maxLength","maxItems","fullText","showAvatars"]).each(function(){q[this]=parseInt(q[this],10)})}function p(){if(d.check()){f=d}else{if(l.check()){f=l}else{if(j.check()){f=j}else{return}}}f.init()}function i(){var r=b.getSelectedName(),m="";if(!r){return}if(r.indexOf('"')==-1){m='"'}else{if(r.indexOf("'")==-1){m="'"}else{if(r.indexOf("`")==-1){m="`"}}}return m+r+m+" "}function c(m){return[o.LEFT,o.RIGHT,o.UP,o.DOWN,o.BACKSPACE,o.ESC,o.SHIFT,o.CTRL,o.ALT,o.ENTER,o.DELETE,o.INSERT,o.END,o.NUMLOCK].indexOf(m)===-1}k(p);g.autoComplete={setup:h};return g})(jQuery,MentionMe||{});