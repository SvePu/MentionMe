var MentionMe=(function($,m){var maxItems=5,options={minLength:3,maxLength:30,},lang={loading:"loading . . .",instructions:"type a user name",},textAreaPadding=2,cursorPointer="pointer",items=[],selection={start:0,end:0,},key={BACKSPACE:8,NEWLINE:10,ENTER:13,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,DEL:46,},$textarea,$container,selectionRange,positioner,cache={},popup={},keyCache={},d={log:function(){},};function setup(opt){$.extend(lang,opt.lang||{});delete opt.lang;$.extend(options,opt||{});}
function init(){var id;if($("#message").length){id="message";}else if($("#signature")){id="signature";}else{return;}
if(!$("#"+id).length){return;}
if(navigator.userAgent.toLowerCase().indexOf("msie")!=-1){cursorPointer="hand";}
$textarea=$("#"+id);$container=$textarea.closest("div");popup.init();positioner=new maxkir.CursorPosition($textarea[0],textAreaPadding);selectionRange=new maxkir.SelectionRange($textarea[0]);$textarea.keyup(onKeyUp);if(m.autoComplete.debug){m.autoComplete.debug.init();}}
function onKeyUp(e){getCaret();if(!popup.isVisible()&&e.keyCode!=key.LEFT&&e.keyCode!=key.RIGHT&&e.keyCode!=key.BACKSPACE&&e.keyCode!=key.ESC){if($textarea.val().slice(selection.start-1,selection.end)=="@"){popup.show();}
return;}
getCaret();switch(e.keyCode){case key.ESC:popup.hide();break;case key.LEFT:case key.RIGHT:keyCache.checkCaret(e.keyCode);break;default:if(keyCache.update()){popup.update();}}}
function insertMention(){var name=popup.getSelectedName(),offset=keyCache.getOffset(),mention,prevChar,quote="";if(!name){if(!popup.spinnerIsVisible()){popup.hide();}
return;}
getCaret();if(name.indexOf('"')==-1){quote='"';}else if(name.indexOf("'")==-1){quote="'";}else if(name.indexOf("`")==-1){quote="`";}
mention="@"+
quote+
name+
quote;$textarea.val($textarea.val().slice(0,offset-1)+
mention+
$textarea.val().slice(offset+
keyCache.getLength()));setCaret(offset+mention.length-1);popup.hide();}
function getCaret(){var range=selectionRange.get_selection_range();selection.start=range[0];selection.end=range[1];}
function setCaret(position){var temp=$textarea[0];if(temp.setSelectionRange){temp.focus();temp.setSelectionRange(position,position);}else if(temp.createTextRange){var range=temp.createTextRange();range.collapse(true);range.moveEnd("character",position);range.moveStart("character",position);range.select();}}
function getPageScroll(){var yScroll;if(self.pageYOffset){yScroll=self.pageYOffset;}else if(document.documentElement&&document.documentElement.scrollTop){yScroll=document.documentElement.scrollTop;}else if(document.body){yScroll=document.body.scrollTop;}
arrayPageScroll=new Array("",yScroll);return arrayPageScroll;}
function getPageSize(){var xScroll,yScroll;if(window.innerHeight&&window.scrollMaxY){xScroll=document.body.scrollWidth;yScroll=window.innerHeight+window.scrollMaxY;}else if(document.body.scrollHeight>document.body.offsetHeight){xScroll=document.body.scrollWidth;yScroll=document.body.scrollHeight;}else{xScroll=document.body.offsetWidth;yScroll=document.body.offsetHeight;}
var windowWidth,windowHeight;if(self.innerHeight){windowWidth=self.innerWidth;windowHeight=self.innerHeight;}else if(document.documentElement&&document.documentElement.clientHeight){windowWidth=document.documentElement.clientWidth;windowHeight=document.documentElement.clientHeight;}else if(document.body){windowWidth=document.body.clientWidth;windowHeight=document.body.clientHeight;}
var pageHeight,pageWidth;if(yScroll<windowHeight){pageHeight=windowHeight;}else{pageHeight=yScroll;}
if(xScroll<windowWidth){pageWidth=windowWidth;}else{pageWidth=xScroll;}
var arrayPageSize=new Array(pageWidth,pageHeight,windowWidth,windowHeight);return arrayPageSize;}
keyCache=(function(){var data="",mirror="",offset=0,caret=0;function init(){data="";getCaret();offset=selection.start;mirror=$textarea.val();caret=0;}
function update(){if($textarea.val()==mirror){return false;}
var insertedChars=($textarea.val().length-mirror.length),newData;if($textarea.val().length<offset||selection.start<offset||data.length+insertedChars>options.maxLength){popup.hide();return false;}
newData=$textarea.val().slice(offset,offset+data.length+insertedChars);updateCaret();if(newData==data){return false;}
data=newData;mirror=$textarea.val();return true;}
function checkCaret(code){if(selection.start<offset||selection.start>offset+data.length||(offset+caret==$textarea.val().length&&code==key.RIGHT)){popup.hide();}
updateCaret();}
function updateCaret(){caret=selection.start-offset;}
function getLength(){return data.length;}
function getText(natural){if(natural!=true){return data.toLowerCase();}
return data;}
function getOffset(){return offset;}
return{init:init,update:update,checkCaret:checkCaret,getLength:getLength,getText:getText,getOffset:getOffset,};})();cache=(function(){var data={},ready=false,loading=false,searching=false,searched=[];function init(){loading=true;$.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"get_name_cache"},success:loadNameCache,});}
function loadNameCache(response){ready=true;loading=false;data=response;if(data.length===0){data={};popup.showInstructions();popup.move();return;}
if(popup.isVisible()){popup.update();}}
function match(){var property,i=0;items=[];for(property in data){if(!data.hasOwnProperty(property)||!data[property]||(keyCache.getLength()&&property.slice(0,keyCache.getLength())!=keyCache.getText())){continue;}
items.push(data[property]);i++;}
items=items.sort(function(a,b){if(a.length<b.length){return-1;}else if(a.length>b.length){return 1;}else{return 0;}});return i;}
function search(){var search=keyCache.getText().slice(0,options.minLength);if(searching||searched.indexOf(search)!=-1){if(popup.spinnerIsVisible()){popup.hide();}
return;}
searched.push(search);searching=true;if(items.length===0){popup.showSpinner();}
$.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"name_search",search:search,},success:load,});}
function load(names){var n=0,property;searching=false;if(!names){if(popup.spinnerIsVisible()){popup.hide();}
return;}
for(property in names){if(!names.hasOwnProperty(property)||data[property]){continue;}
data[property]=names[property];n++;}
if(!n||!popup.isVisible()){return;}
match();popup.buildItems();popup.select();}
function isReady(){return ready;}
function isLoading(){return loading;}
return{init:init,match:match,search:search,isReady:isReady,isLoading:isLoading,};})();popup=(function(){var visible=false,selected=0,lastSelected=null,$div,$spinner,spinnerVisible=false,lineHeight,width=0;function init(){var e;$div=$("<div/>",{id:"mentionme_popup","class":"mentionme_popup",}).css({left:"-1000px",top:"-1000px",});$container.append($div);$div.show();for(e=0;e<maxItems;e++){$div.append($("<div/>").html(Array(options.maxLength+1).join("M")).addClass("mentionme_popup_item"));}
lineHeight=parseInt($div.height()/maxItems);width=$div.css("fontSize").replace("px","")*(options.maxLength-1);$spinner=$("<div/>",{id:"mentionme_spinner","class":"mentionme_spinner",}).append($("<img/>",{src:"images/spinner.gif",}));$spinner.append($("<span/>").html(lang.loading));$div.html($spinner);}
function show(){var coords=positioner.getPixelCoordinates(),taCoords=$textarea[0].getBoundingClientRect(),left,top;if(!cache.isReady()&&!cache.isLoading()){cache.init();}
keyCache.init();popup.update();left=taCoords.left+coords[0];top=taCoords.top+coords[1]+getPageScroll()[1];move(left,top);$div.show();lastSelected=null;select();visible=true;$div.mouseover(onMouseMove);$div.click(onClick);$(document).click(hide);$textarea.click(hide);$textarea.keydown(onKeyDown);}
function hide(){$div.hide();$div.unbind("mouseover",onMouseMove);$div.unbind("click",onClick);$(document).unbind("click",hide);$textarea.unbind("click",hide);$textarea.unbind("keydown",onKeyDown);visible=false;}
function clear(){$div.html("");lastSelected=null;spinnerVisible=false;}
function update(){if(!cache.isReady()){popup.showSpinner();return;}
cache.match();buildItems();lastSelected=null;select();if(keyCache.getLength()>=options.minLength){cache.search();}}
function buildItems(){var thisClass;if(items.length===0&&spinnerVisible==false){if(keyCache.getLength()>0){clear();$div.html(keyCache.getText());}else{showInstructions();}
move();return;}
clear();for(i=0;i<items.length;i++){$div.append($("<div/>",{id:"mentionme_popup_item_"+i,"class":"mentionme_popup_item"}).html(items[i]).css({cursor:cursorPointer,}));}
move();}
function move(left,top){var style={height:getCurrentHeight()+"px",overflow:"auto",width:width+"px",};if(left){style.left=left+"px";}
if(top){style.top=top+"px";}
$div.css(style);}
function highlightSelected(noScroll){if(lastSelected==selected||!$("#mentionme_popup_item_"+selected)){return;}
var selectedItem=$("#mentionme_popup_item_"+selected);if($("#mentionme_popup_item_"+lastSelected)){$("#mentionme_popup_item_"+lastSelected).removeClass("mentionme_popup_item_on");}
lastSelected=selected;if(selectedItem&&!selectedItem.hasClass("mentionme_popup_item_on")){selectedItem.addClass("mentionme_popup_item_on");}
if(noScroll!=true){selectedItem.parent("div").prop("scrollTop",selectedItem.prop("offsetTop"));}}
function onKeyDown(event){switch(event.keyCode){case key.ENTER:insertMention();break;case key.UP:select("previous");break;case key.DOWN:select("next");break;case key.END:select("last");break;case key.HOME:select();break;case key.PAGE_UP:select("previousPage");break;case key.PAGE_DOWN:select("nextPage");break;default:return;}
event.preventDefault();}
function onMouseMove(event){if(selectEventTarget(event)){highlightSelected(true);}}
function onClick(e){if(selectEventTarget(e)){insertMention();}else{e.preventDefault();}}
function selectEventTarget(e){if(!e){return false;}
var idParts,target=e.target;try{if(!target||!target.id||target.id=="mentionme_popup"||target.id=="mentionme_spinner"){return false;}}catch(e){return false;}
idParts=target.id.split("_");if(!idParts||idParts.length==0||!idParts[idParts.length-1]){return false;}
selected=idParts[idParts.length-1];return true;}
function getSelectedName(){if(items.length===0||!items[selected]){return;}
return items[selected];}
function select(selection){switch(selection){case"last":selected=items.length-1;break;case"next":selected++;if(selected>items.length-1){selected=0;}
break;case"previous":selected--;if(selected<0){selected=items.length-1;}
break;case"nextPage":selected+=maxItems;if(selected>items.length-1){selected=items.length-1;}
break;case"previousPage":selected-=maxItems;if(selected<0){selected=0;}
break;default:selected=0;break;}
highlightSelected();}
function spinnerIsVisible(){return spinnerVisible;}
function showSpinner(){clear();$div.html($spinner);spinnerVisible=true;move();}
function showInstructions(){clear();$div.html('<span style="color: grey; font-style: italic;">'
+lang.instructions+"</span>");}
function getCurrentHeight(){return(lineHeight*Math.max(1,Math.min(5,items.length)))+4;}
function isVisible(){return visible;}
return{init:init,hide:hide,show:show,move:move,clear:clear,update:update,buildItems:buildItems,select:select,getSelectedName:getSelectedName,showSpinner:showSpinner,isVisible:isVisible,spinnerIsVisible:spinnerIsVisible,showInstructions:showInstructions,};})();m.autoComplete={setup:setup,};$(init);return m;})(jQuery,MentionMe||{});