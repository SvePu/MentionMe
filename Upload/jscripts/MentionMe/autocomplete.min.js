var MentionMe=(function(k,g){var r={minLength:3,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1},e={instructions:"type a user name"},p={BACKSPACE:8,NEWLINE:10,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},o=(typeof Object.keys==="function")?Object.keys:(function(){var t=Object.prototype.hasOwnProperty,u=!({toString:null}).propertyIsEnumerable("toString"),s=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],m=s.length;return function(x){if(typeof x!=="object"&&(typeof x!=="function"||x===null)){throw new TypeError("Object.keys called on non-object")}var v=[],y,w;for(y in x){if(t.call(x,y)){v.push(y)}}if(u){for(w=0;w<m;w++){if(t.call(x,s[w])){v.push(s[w])}}}return v}}()),b=(function(){var N=false,y=false,O=0,ac=null,m=0,C=0,I,P,J=[],Q=[],v,w,K,S,Z,R;function ab(){var ag,af,ae=f.getContainer();w=k("#mentionme_popup");K=k("#mentionme_spinner").hide();S=k("#mentionme_popup_input");Z=k("#mentionme_popup_input_container");R=k("#mentionme_popup_body");if(typeof ae==="string"&&k("#"+ae).length){v=k("#"+ae)}else{if(typeof ae==="object"&&k(ae).length){v=k(ae)}else{return false}}v.append(w);w.css({left:"-1000px",top:"-1000px"}).show();I=Z.height();ag=k("<div/>");if(r.showAvatars){af=k("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).appendTo(ag)}ag.append(Array(r.maxLength+1).join("M")).addClass("mentionme_popup_item");R.html(ag);P=parseInt(ag.height())+f.lineHeightModifier+parseInt(ag.css("paddingTop").replace("px",""))+parseInt(ag.css("paddingBottom").replace("px",""));C=R.width()-R[0].scrollWidth}function U(af,ae){if(!a.isReady()&&!a.isLoading()){a.init()}n.init();T();G(af,ae);w.show();ac=null;X();N=true;R.mouseover(s);R.click(M);k(document).click(Y);f.bindClick(Y);S.keydown(z);S.keyup(A);S.click(D);S.focus()}function Y(){w.hide();R.unbind("mouseover",s);R.unbind("click",M);k(document).unbind("click",Y);f.unBindClick(Y);S.unbind("keydown",z);S.unbind("keyup",A);S.unbind("click",D);N=false;S.val("");f.focus()}function G(ai,ah){var ag,af=a.getLongestName(),ae;m=0;if(r.showAvatars){ae=k("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).css({left:"-1000px",top:"-1000px"}).appendTo(v);m+=ae.width();ae.remove()}m+=parseInt(R.css("fontSize").replace("px","")*af);ag={height:F()+I+"px",width:parseInt(m-C)+"px"};if(typeof ai!="undefined"){ag.left=ai+"px"}if(typeof ah!="undefined"){ag.top=ah+"px"}w.css(ag);R.css({height:F()+"px",width:m})}function T(){if(!a.isReady()){ad();return}a.match();L();ac=null;X();if(n.getLength()>=r.minLength){a.search()}}function L(){var af,ah,ae,aj,ag=a.getItemsLength(),ai=(navigator.userAgent.toLowerCase().indexOf("msie")!==-1)?"hand":"pointer";J=a.getItems();Q=a.getAvatars();if(ag===0&&y==false){if(n.getLength()>0){V();R.html(n.getText())}else{aa()}if(u()){G()}return}V();for(af=0;af<ag;af++){ah=J[af];if(n.getText()){aj=J[af].toLowerCase().indexOf(n.getText());if((r.fullText&&aj!==-1)||(!r.fullText&&aj===0)){ah=J[af].slice(0,aj)+'<span class="mention_name_highlight">'+J[af].slice(aj,aj+n.getText().length)+"</span>"+J[af].slice(aj+n.getText().length)}}ae="";if(r.showAvatars){if(!Q[af]){Q[af]="images/default_avatar.png"}ae='<img class="mention_user_avatar" src="'+Q[af]+'" />'}R.append(k("<div/>",{id:"mentionme_popup_item_"+af,"class":"mentionme_popup_item"}).html(ae+ah).css({cursor:ai}))}if(u()){G()}}function V(){R.html("");ac=null;y=false;if(u()){G()}}function ad(){V();R.html(K);y=true;if(u()){G()}}function aa(){V();R.html('<span style="color: grey; font-style: italic;">'+e.instructions+"</span>")}function A(){if(n.update()){T()}}function X(ae){var af=a.getItemsLength()-1;switch(ae){case"last":O=af;break;case"next":O++;if(O>af){O=0}break;case"previous":O--;if(O<0){O=af}break;case"nextPage":O+=r.maxItems;if(O>af){O=af}break;case"previousPage":O-=r.maxItems;if(O<0){O=0}break;default:O=0;break}t()}function t(ah){if(ac==O||k("#mentionme_popup_item_"+O).length===0){return}var ag=k("#mentionme_popup_item_"+O),af=k("#mentionme_popup_item_"+ac),ae=af.find("span.mention_name_highlight_on");if(af.length){af.removeClass("mentionme_popup_item_on");if(ae.length){ae.removeClass("mention_name_highlight_on");ae.addClass("mention_name_highlight")}}ac=O;if(ag){if(!ag.hasClass("mentionme_popup_item_on")){ag.addClass("mentionme_popup_item_on")}ae=ag.find("span.mention_name_highlight");if(ae.length){ae.removeClass("mention_name_highlight");ae.addClass("mention_name_highlight_on")}}if(ah!=true&&(a.getItemsLength()-r.maxItems)>0){R.prop("scrollTop",parseInt(ag.prop("offsetTop")-I))}}function z(ae){switch(ae.keyCode){case p.ENTER:f.insert();break;case p.UP:X("previous");break;case p.DOWN:X("next");break;case p.END:X("last");break;case p.HOME:X();break;case p.PAGE_UP:X("previousPage");break;case p.PAGE_DOWN:X("nextPage");break;case p.ESC:Y();break;case p.BACKSPACE:if(S.val()===""){Y()}return;break;default:return}ae.preventDefault()}function s(ae){if(H(ae)){t(true)}}function M(ae){if(H(ae)){f.insert()}else{ae.preventDefault()}}function D(ae){ae.stopPropagation()}function H(ag){if(!ag){return false}var ae,af=ag.target;try{if(!af||!af.id||af.id=="mentionme_popup"||af.id=="mentionme_spinner"){return false}}catch(ag){return false}ae=af.id.split("_");if(!ae||ae.length==0||!ae[ae.length-1]){return false}O=ae[ae.length-1];return true}function B(){if(a.getItemsLength()===0||!J[O]){return}return J[O]}function F(){return(P*Math.max(1,Math.min(r.maxItems,a.getItemsLength())))+f.heightModifier+4}function W(){return S.val()}function x(){return P}function E(){return y}function u(){return N}return{init:ab,show:U,hide:Y,move:G,update:T,buildItems:L,showSpinner:ad,showInstructions:aa,select:X,getSelectedName:B,getCurrentHeight:F,getInputValue:W,getLineHeight:x,spinnerIsVisible:E,isVisible:u}})(),n=(function(){var t="",u="";function v(){t="";u=""}function w(){var x=false,y=b.getInputValue();if(t!==y){x=true}t=y;return x}function s(){return t.length}function m(x){if(x!=true){return t.toLowerCase()}return t}return{init:v,update:w,getLength:s,getText:m}})(),a=(function(){var M={},K={},C={},B=false,t=false,L=false,G=[],F=[],w=[],y=5;function J(){t=true;k.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:r.tid},success:x})}function x(O){B=true;t=false;K=O.inThread;C=O.cached;k.extend(M,K,C);if(M.length===0){M={};b.showInstructions();if(b.isVisible()){b.move()}return}if(b.isVisible()){b.update()}}function u(){var S,Q=0,O={},U=[],R=[],T=[],P=[];F=[];w=[];y=5;for(S in K){if(!E(S,K,O)){continue}if(S.length>y){y=S.length}U.push(K[S]["username"]);if(r.showAvatars){T.push(K[S]["avatar"])}O[S]=true;Q++}k.merge(F,U);if(r.showAvatars){k.merge(w,T)}for(S in M){if(!E(S,M,O)){continue}if(S.length>y){y=S.length}R.push(M[S]["username"]);if(r.showAvatars){P.push(M[S]["avatar"])}O[S]=true;Q++}R=R.sort(A);k.merge(F,R);if(r.showAvatars){k.merge(w,P)}return Q}function A(P,O){if(P.length<O.length){return -1}else{if(P.length>O.length){return 1}else{return 0}}}function E(Q,P,O){if(!P.hasOwnProperty(Q)||!P[Q]||O[Q]||(n.getLength()&&((!r.fullText&&Q.slice(0,n.getLength())!==n.getText())||(r.fullText&&Q.indexOf(n.getText())===-1)))){return false}return true}function z(){var O=n.getText().slice(0,r.minLength);if(L||G.indexOf(O)!==-1){if(b.spinnerIsVisible()){b.hide()}return}G.push(O);L=true;if(F.length===0){b.showSpinner()}k.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:O},success:v})}function v(P){var Q=0,O;L=false;if(!P){if(b.spinnerIsVisible()){b.hide()}return}for(O in P){if(!P.hasOwnProperty(O)||M[O]){continue}M[O]=P[O];Q++}if(!Q||!b.isVisible()){return}u();b.buildItems();b.select()}function H(){return B}function I(){return t}function m(){return F}function s(){return w}function N(){return F.length}function D(){return y}return{init:J,match:u,search:z,isReady:H,isLoading:I,getItems:m,getAvatars:s,getItemsLength:N,getLongestName:D}})(),j=(function(){var w,B,A={start:0,end:0};function m(){if(k("#message").length==0&&k("#signature").length==0){return false}return true}function C(){var F;if(k("#message").length){F="message"}else{if(k("#signature").length){F="signature"}}if(!F||!k("#"+F).length){return false}w=k("#"+F);B=w.closest("div");b.init();w.keyup(E)}function E(F){u();if(!b.isVisible()){if(c(F.keyCode)&&w.val().slice(A.start-1,A.end)=="@"){z()}}}function z(){var F=w.caret("offset"),H=F.left+3,G=F.top-5;b.show(H,G)}function t(){var F=i();if(!F){if(!b.spinnerIsVisible()){b.hide()}return}u();w.val(w.val().slice(0,A.start)+F+w.val().slice(A.start));s(A.start+F.length);b.hide()}function u(){var F=w.caret("pos");A.start=F;A.end=F}function s(F){var H=w[0],G;if(H.setSelectionRange){H.focus();H.setSelectionRange(F,F)}else{if(H.createTextRange){G=H.createTextRange();G.collapse(true);G.moveEnd("character",F);G.moveStart("character",F);G.select()}}}function x(F){w.click(F)}function v(F){w.unbind("click",F)}function D(){w.focus()}function y(){return B}return{init:C,check:m,heightModifier:0,lineHeightModifier:0,insert:t,bindClick:x,unBindClick:v,focus:D,getContainer:y}})(),l=(function(){var x,u,C={start:0,end:0},E,A,w,F;function m(){if(MyBBEditor===null||typeof MyBBEditor!=="object"||!MyBBEditor.getRangeHelper||typeof MyBBEditor.getRangeHelper!=="function"){return false}return true}function D(){x=MyBBEditor;u=x.getRangeHelper();A=k("iframe");E=A.closest("div");w=x.getBody();x.keyUp(H);b.init()}function H(I){t();if(!I.keyCode){if(I.originalEvent&&I.originalEvent.keyCode){I.keyCode=I.originalEvent.keyCode}else{return}}if(!b.isVisible()){if(c(I.keyCode)&&F.text().slice(C.start-1,C.end)=="@"){B()}return}}function B(){var I=w.caret("offset",{iframe:A[0]}),K=parseInt(I.left)+7,J=parseInt(I.top+E.find("div.sceditor-toolbar").height())+2;b.show(K,J)}function s(){var I=i();if(!I){if(!b.spinnerIsVisible()){b.hide()}return}x.insert(I);b.hide()}function t(){var I=u.selectedRange();if(I.startContainer){F=k(I.startContainer)}else{F=k(x.currentNode())}C.start=I.startOffset;C.end=I.endOffset}function y(I){w.click(I)}function v(I){w.unbind("click",I)}function G(){A.focus()}function z(){return E}return{init:D,check:m,heightModifier:0,lineHeightModifier:0,insert:s,bindClick:y,unBindClick:v,focus:G,getContainer:z}})(),d=(function(){var x,D,B,w,v;function m(){if(typeof CKEDITOR==="undefined"||typeof CKEDITOR.instances==="undefined"||CKEDITOR.instances.length==0){return false}return true}function E(){var H=o(CKEDITOR.instances)[0];if(typeof CKEDITOR.instances[H]!=="object"){return false}x=CKEDITOR.instances[H];x.on("instanceReady",A)}function A(){B=k("iframe");D=B.closest("div");w=k(x.document.$);v=w.find("body");w.keyup(G);b.init()}function G(H){if(!b.isVisible()){if(c(H.keyCode)&&u()=="@"){C()}return}}function C(){var H=v.caret("offset",{iframe:B[0]}),K=B.offset(),J=parseInt(H.left+K.left)+2,I=parseInt(H.top+K.top)-5;b.show(J,I)}function s(){var H=i();if(!H){if(!b.spinnerIsVisible()){b.hide()}return}x.insertText(H);b.hide()}function u(){var H=x.getSelection().getRanges()[0],I,J;if(!H||!H.startContainer){return null}I=H.startContainer;if(I.type==CKEDITOR.NODE_TEXT&&H.startOffset){return I.getText()[H.startOffset-1]}else{H.collapse(true);H.setStartAt(x.editable(),CKEDITOR.POSITION_AFTER_START);J=new CKEDITOR.dom.walker(H),node;while((node=J.previous())){if(node.type==CKEDITOR.NODE_TEXT){return node.getText().slice(-1)}}}return null}function y(H){w.click(H)}function t(H){w.unbind("click",H)}function F(){x.focus()}function z(){return D}return{init:E,check:m,heightModifier:0,lineHeightModifier:0,insert:s,bindClick:y,unBindClick:t,focus:F,getContainer:z}})(),f=null;function h(m){k.extend(e,m.lang||{});delete m.lang;k.extend(r,m||{});k(["minLength","maxLength","maxItems","fullText","showAvatars"]).each(function(){r[this]=parseInt(r[this],10)})}function q(){if(d.check()){f=d}else{if(l.check()){f=l}else{if(j.check()){f=j}else{return}}}f.init()}function i(){var s=b.getSelectedName(),m="";if(!s){return}if(s.indexOf('"')==-1){m='"'}else{if(s.indexOf("'")==-1){m="'"}else{if(s.indexOf("`")==-1){m="`"}}}return m+s+m+" "}function c(m){return[p.LEFT,p.RIGHT,p.UP,p.DOWN,p.BACKSPACE,p.ESC,p.SHIFT,p.CTRL,p.ALT,p.ENTER,p.DELETE,p.INSERT,p.END,p.NUMLOCK].indexOf(m)===-1}k(q);g.autoComplete={setup:h};return g})(jQuery,MentionMe||{});