/*
 * Plugin Name: MentionMe for MyBB 1.8.x
 * Copyright 2014 WildcardSearch
 * http://www.rantcentralforums.com
 *
 * this file contains a module for the auto-completion functionality
 */
var MentionMe=function(t,e){"use strict";function i(e){var i,s=this.id.split("_").slice(-1)[0],n="quickedit_"+s;0!=t("#"+n).length&&("undefined"==typeof CKEDITOR?i=new f(n):setTimeout(function(){i=new g(n)},1100),setTimeout(function(){t("#quicksub_"+s).add(t("#quicksub_"+s).next("button")).click(function(){i.unbindKeyup()})},1100))}function s(e){t(".quick_edit_button").off("click",i),setTimeout(function(){t(".quick_edit_button").click(i)},500)}function n(t){var e=t.getSelectedName(),i="";if(e)return-1==e.indexOf('"')?i='"':-1==e.indexOf("'")?i="'":-1==e.indexOf("`")&&(i="`"),i+e+i+" "}function h(t){return-1===[p.LEFT,p.RIGHT,p.UP,p.DOWN,p.BACKSPACE,p.ESC,p.SHIFT,p.CTRL,p.ALT,p.ENTER,p.DELETE,p.INSERT,p.END,p.NUMLOCK].indexOf(t)}function o(t,e){return t.length<e.length?-1:t.length>e.length?1:0}function a(t){return parseInt(t,10)}var r={minLength:3,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1,imageDirectory:"images",lockSelection:1},c={instructions:"type a user name"},p={BACKSPACE:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},u=function(){function e(e){var i,s;if(this.editorInterface=e,s=this.editorInterface.getContainer(),this.$popup=t("#mentionme_master_popup").clone().attr("id",""),this.$spinner=this.$popup.find("div.mentionme_spinner").hide(),this.$input=this.$popup.find("input.mentionme_popup_input"),this.$inputDiv=this.$popup.find("div.mentionme_popup_input_container"),this.$body=this.$popup.find("div.mentionme_popup_body"),"string"==typeof s&&t("#"+s).length)this.$container=t("#"+s);else{if("object"!=typeof s||!t(s).length)return!1;this.$container=t(s)}this.$container.append(this.$popup),this.$popup.css({left:"-1000px",top:"-1000px"}).show(),this.inputHeight=this.$inputDiv.height(),i=t("<div/>"),r.showAvatars&&t("<img/>",{class:"mention_user_avatar",src:r.defaultAvatar}).appendTo(i),i.append(Array(r.maxLength+1).join("M")).addClass("mentionme_popup_item"),this.$body.html(i),this.lineHeight=a(i.height())+this.editorInterface.lineHeightModifier+a(i.css("paddingTop").replace("px",""))+a(i.css("paddingBottom").replace("px","")),this.$instructions=t("<span/>",{class:"mentionme_popup_instructions"}).html(c.instructions),this.scrollWidthDiff=this.$body.width()-this.$body[0].scrollWidth,this.keyCache=new l(this),this.nameCache=new d(this)}return t.extend(e.prototype,{show:function(e,i){this.keyCache.clear(),this.update(),this.move(e,i),this.$popup.show(),this.lastSelected=null,this.select(),this.visible=!0,this.$body.mouseover(t.proxy(this.onMouseMove,this)),this.$body.click(t.proxy(this.onClick,this)),t(document).click(t.proxy(this.hide,this)),this.editorInterface.bindClick(t.proxy(this.hide,this)),this.$input.keydown(t.proxy(this.onKeyDown,this)),this.$input.keyup(t.proxy(this.updateCheck,this)),this.$input.click(t.proxy(this.onInputClick,this)),this.$input.focus()},hide:function(){this.$popup.hide(),this.$body.off("mouseover",this.onMouseMove),this.$body.off("click",this.onClick),t(document).off("click",this.hide),this.editorInterface.unbindClick(this.hide),this.$input.off("keydown",this.onKeyDown),this.$input.off("keyup",this.updateCheck),this.$input.off("click",this.onInputClick),this.visible=!1,this.$input.val("")},move:function(e,i){var s,n,h=this.nameCache.getLongestName();this.width=0,r.showAvatars&&(n=t("<img/>",{class:"mention_user_avatar",src:r.defaultAvatar}).css({left:"-1000px",top:"-1000px"}).appendTo(this.$container),this.width+=n.width(),n.remove()),this.width+=a(this.$body.css("fontSize").replace("px","")*h),s={height:this.getCurrentHeight()+this.inputHeight+"px",width:a(this.width-this.scrollWidthDiff)+"px"},void 0!==e&&(s.left=e+"px"),void 0!==i&&(s.top=i+"px"),this.$popup.css(s),this.$body.css({height:this.getCurrentHeight()+"px",width:this.width})},update:function(){this.nameCache.isReady()?(this.nameCache.match(),this.buildItems(),this.lastSelected=null,this.select(),this.keyCache.getLength()>=r.minLength&&this.nameCache.search()):this.showSpinner()},buildItems:function(){var e,i,s,n,h,o=this.nameCache.getItemsLength(),a=this.nameCache.getData(),c=-1!==navigator.userAgent.toLowerCase().indexOf("msie")?"hand":"pointer";if(this.items=this.nameCache.getItems(),0===o&&0==this.spinnerVisible)return this.keyCache.getLength()>0?(this.clear(),this.$body.html(this.keyCache.getText())):this.showInstructions(),void(this.isVisible()&&this.move());for(this.clear(),e=0;e<o;e++)i=a[this.items[e]].username,this.keyCache.getText()&&(h=this.items[e].indexOf(this.keyCache.getText()),(r.fullText&&-1!==h||!r.fullText&&0===h)&&(i=i.slice(0,h)+'<span class="mention_name_highlight">'+i.slice(h,h+this.keyCache.getLength())+"</span>"+i.slice(h+this.keyCache.getLength()))),s="",r.showAvatars&&(0==(n=a[this.items[e]].avatar).length&&(n=r.defaultAvatar),s=t("<img/>",{class:"mention_user_avatar",src:n}).one("error",function(){this.src=r.defaultAvatar})),this.$body.append(t("<div/>",{class:"mentionme_popup_item mentionme_popup_item_"+e}).append(s).append(i).css({cursor:c}));this.isVisible()&&this.move()},clear:function(){this.$body.html(""),this.lastSelected=null,this.spinnerVisible=!1,this.isVisible()&&this.move()},showSpinner:function(){this.clear(),this.$body.html(this.$spinner),this.spinnerVisible=!0,this.isVisible()&&this.move()},showInstructions:function(){this.clear(),this.$body.html(this.$instructions)},updateCheck:function(){this.keyCache.update()&&this.update()},select:function(t){var e=this.nameCache.getItemsLength()-1;switch(t){case"last":this.selected=e;break;case"next":++this.selected>e&&(this.selected=0);break;case"previous":--this.selected<0&&(this.selected=e);break;case"nextPage":this.selected+=r.maxItems,this.selected>e&&(this.selected=e);break;case"previousPage":this.selected-=r.maxItems,this.selected<0&&(this.selected=0);break;default:this.selected=0}this.highlightSelected()},highlightSelected:function(t){var e=this.$popup.find(".mentionme_popup_item_"+this.selected),i=this.$popup.find(".mentionme_popup_item_"+this.lastSelected),s=i.find("span.mention_name_highlight_on"),n=this.itemInView(e);this.lastSelected!=this.selected&&0!=e.length&&(i.length&&(i.removeClass("mentionme_popup_item_on"),s.length&&(s.removeClass("mention_name_highlight_on"),s.addClass("mention_name_highlight"))),this.lastSelected=this.selected,e&&(e.hasClass("mentionme_popup_item_on")||e.addClass("mentionme_popup_item_on"),(s=e.find("span.mention_name_highlight")).length&&(s.removeClass("mention_name_highlight"),s.addClass("mention_name_highlight_on"))),t||1!==r.lockSelection&&!0===n||(r.lockSelection?this.nameCache.getItemsLength()-r.maxItems>0&&this.$body.prop("scrollTop",a(e.prop("offsetTop")-this.inputHeight)):0!=this.selected?n>0?this.$body.prop("scrollTop",a(e.prop("offsetTop")-(this.getCurrentHeight()-this.lineHeight)-this.inputHeight)):this.$body.prop("scrollTop",a(e.prop("offsetTop")-this.inputHeight)):this.$body.prop("scrollTop",-this.inputHeight)))},itemInView:function(t){var e=t.prop("offsetTop")-this.$body.prop("scrollTop");return e>0&&e+this.lineHeight<this.getCurrentHeight()||e},onKeyDown:function(t){switch(t.keyCode){case p.ENTER:this.editorInterface.insert();break;case p.UP:this.select("previous");break;case p.DOWN:this.select("next");break;case p.END:this.select("last");break;case p.HOME:this.select();break;case p.PAGE_UP:this.select("previousPage");break;case p.PAGE_DOWN:this.select("nextPage");break;case p.ESC:this.hide();break;case p.BACKSPACE:return void(""===this.$input.val()&&(this.hide(),this.editorInterface.focus()));default:return}t.preventDefault()},onMouseMove:function(t){this.selectEventTarget(t)&&this.highlightSelected(!0)},onClick:function(t){this.selectEventTarget(t)?this.editorInterface.insert():t.preventDefault()},onInputClick:function(t){t.stopPropagation()},selectEventTarget:function(e){if(!e)return!1;var i,s,n,h=t(e.target),o=!1;if(0!=h.length&&h.hasClass("mentionme_popup_item")){for(i=h.prop("class").split(" ");s=i.shift();)if(void 0!==s&&-1===["mentionme_popup_item","mentionme_popup_item_on"].indexOf(s)&&0===s.indexOf("mentionme_popup_item_")){o=!0;break}return n=s.split("_"),!!(o&&n&&0!=n.length&&n[n.length-1])&&(this.selected=n[n.length-1],!0)}},getSelectedName:function(){if(0!==this.nameCache.getItemsLength()&&this.items[this.selected])return this.nameCache.getData()[this.items[this.selected]].username},getCurrentHeight:function(){return this.lineHeight*Math.max(1,Math.min(r.maxItems,this.nameCache.getItemsLength()))+this.editorInterface.heightModifier+4},getInputValue:function(){return this.$input.val()},getLineHeight:function(){return this.lineHeight},spinnerIsVisible:function(){return this.spinnerVisible},isVisible:function(){return this.visible}}),e}(),l=function(){function e(t){this.popup=t,this.clear()}return t.extend(e.prototype,{clear:function(){this.data="",this.mirror=""},update:function(){var t=!1,e=this.popup.getInputValue();return this.data!==e&&(t=!0),this.data=e,t},getLength:function(){return this.data.length},getText:function(t){return 1!=t?this.data.toLowerCase():this.data}}),e}(),d=function(){function e(e){this.data={},this.threadNames={},this.allNames={},this.ready=!1,this.loading=!0,this.searching=!1,this.searched=[],this.items=[],this.longestName=5,this.popup=e,this.editorInterface=this.popup.editorInterface,this.keyCache=e.keyCache,t.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:r.tid},success:this.loadNameCache.bind(this)})}function i(t){var e,i=0;if(this.searching=!1,t){for(e in t)t.hasOwnProperty(e)&&!this.data[e]&&(this.data[e]=t[e],i++);i&&this.popup.isVisible()&&(this.match(),this.popup.buildItems(),this.popup.select())}else this.popup.spinnerIsVisible()&&(this.popup.hide(),this.editorInterface.focus())}return t.extend(e.prototype,{loadNameCache:function(e){if(this.ready=!0,this.loading=!1,this.threadNames=e.inThread,this.allNames=e.cached,t.extend(this.data,this.threadNames,this.allNames),t.isEmptyObject(this.data))return this.data={},this.popup.showInstructions(),void(this.popup.isVisible()&&this.popup.move());this.popup.isVisible()&&this.popup.update()},match:function(){var e,i=0,s={},n=[];this.items=[],this.longestName=5;for(e in this.threadNames)this.checkEntry(e,this.threadNames,s)&&(this.items.push(e),s[e]=!0,i++);for(e in this.data)this.checkEntry(e,this.data,s)&&(n.push(e),s[e]=!0,i++);return n=n.sort(o),t.merge(this.items,n),i},checkEntry:function(t,e,i){return!(!e.hasOwnProperty(t)||!e[t]||i[t]||this.keyCache.getLength()&&(!r.fullText&&t.slice(0,this.keyCache.getLength())!==this.keyCache.getText()||r.fullText&&-1===t.indexOf(this.keyCache.getText()))||(t.length>this.longestName&&(this.longestName=t.length),0))},search:function(){var e=this.keyCache.getText().slice(0,r.minLength);this.searching||-1!==this.searched.indexOf(e)?this.popup.spinnerIsVisible()&&(this.popup.hide(),this.editorInterface.focus()):(this.searched.push(e),this.searching=!0,0===this.items.length&&this.popup.showSpinner(),t.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:e},success:i.bind(this)}))},load:i,isReady:function(){return this.ready},isLoading:function(){return this.loading},getData:function(){return this.data},getItems:function(){return this.items},getItemsLength:function(){return this.items.length},getLongestName:function(){return this.longestName}}),e}(),f=function(){function e(e){this.$textarea=t("#"+e),this.$container=this.$textarea.closest("div"),this.selection={start:0,end:0},this.popup=new u(this),this.bindKeyup()}return t.extend(e.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:function(t){this.popup.isVisible()||(this.getCaret(),h(t.keyCode)&&"@"==this.$textarea.val().slice(this.selection.start-1,this.selection.end)&&this.showPopup())},showPopup:function(){var t=this.$textarea.caret("offset"),e=t.left+3,i=t.top-5;this.popup.show(e,i)},insert:function(){var t=n(this.popup);t?(this.getCaret(),this.$textarea.val(this.$textarea.val().slice(0,this.selection.start)+t+this.$textarea.val().slice(this.selection.start)),this.setCaret(this.selection.start+t.length),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getCaret:function(){var t=this.$textarea.caret("pos");this.selection.start=t,this.selection.end=t},setCaret:function(t){var e,i=this.$textarea[0];i.setSelectionRange?(i.focus(),i.setSelectionRange(t,t)):i.createTextRange&&((e=i.createTextRange()).collapse(!0),e.moveEnd("character",t),e.moveStart("character",t),e.select())},bindClick:function(t){this.$textarea.click(t)},unbindClick:function(t){this.$textarea.off("click",t)},bindKeyup:function(){this.$textarea.keyup(t.proxy(this.onKeyUp,this))},unbindKeyup:function(){this.$textarea.off("keyup")},focus:function(){this.$textarea.focus()},getContainer:function(){return this.$container}}),e}(),m=function(){function e(){this.editor=MyBBEditor,this.rangeHelper=this.editor.getRangeHelper(),this.$iFrame=t("iframe"),this.$container=this.$iFrame.closest("td"),this.$body=this.editor.getBody(),this.selection={start:0,end:0},this.popup=new u(this),this.editor.keyUp(this.onKeyUp.bind(this))}return t.extend(e.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:function(t){if(this.getCaret(),!t.keyCode){if(!t.originalEvent||!t.originalEvent.keyCode)return;t.keyCode=t.originalEvent.keyCode}this.popup.isVisible()||h(t.keyCode)&&"@"==this.$currentNode.text().slice(this.selection.start-1,this.selection.end)&&this.showPopup()},showPopup:function(){var t,e,i,s=this.$body.caret("offset",{iframe:this.$iFrame[0]}),n=this.$container.offset();t=7,this.$currentNode.closest("div").length&&"function"==typeof this.$currentNode.closest("div").css&&(t=a(this.$currentNode.closest("div").css("fontSize").replace("px","")/2)),e=a(s.left)+n.left+a(this.$container.css("paddingLeft").replace("px",""))+t+2,i=a(s.top+this.$container.find("div.sceditor-toolbar").height())+n.top+a(this.$container.css("paddingTop").replace("px",""))+3,this.popup.show(e,i)},insert:function(){var t=n(this.popup);t?(this.editor.insert(t),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getCaret:function(){var e=this.rangeHelper.selectedRange();e.startContainer?this.$currentNode=t(e.startContainer):this.$currentNode=t(editor.currentNode()),this.selection.start=e.startOffset,this.selection.end=e.endOffset},bindClick:function(t){this.$body.click(t)},unbindClick:function(t){this.$body.off("click",t)},focus:function(){this.$iFrame.focus()},getContainer:function(){return this.$container}}),e}(),g=function(){function e(e){0!==t("#"+e).length&&void 0!==CKEDITOR.instances[e]&&(this.id=e,this.editor=CKEDITOR.instances[this.id],"message"===e||"signature"===e?this.editor.on("instanceReady",t.proxy(this.finalize,this)):this.finalize(),t("#quick_reply_submit").click(t.proxy(this.quickReplyPosted,this)))}return t.extend(e.prototype,{heightModifier:0,lineHeightModifier:0,finalize:function(){this.$iFrame=t("#cke_"+this.id).find("iframe"),this.$container=this.$iFrame.closest("div"),this.$doc=t(this.editor.document.$),this.$body=this.$doc.find("body"),this.bindKeyup(),this.popup=new u(this)},onKeyUp:function(t){this.popup.isVisible()||h(t.keyCode)&&"@"==this.getPrevChar()&&this.showPopup()},quickReplyPosted:function(){void 0!==this.$doc&&this.$doc.length&&this.$doc.off("keyup",this.onKeyUp),setTimeout(t.proxy(function(){this.$doc.keyup(t.proxy(this.onKeyUp,this))},this),500)},showPopup:function(){var t=this.$body.caret("offset",{iframe:this.$iFrame[0]}),e=this.$iFrame.offset(),i=a(t.left+e.left)+2,s=a(t.top+e.top)-5;this.popup.show(i,s)},insert:function(){var t=n(this.popup);t?(this.editor.insertText(t),this.popup.hide()):this.popup.spinnerIsVisible()||this.popup.hide()},getPrevChar:function(){var t,e,i,s=this.editor.getSelection().getRanges()[0];if(!s||!s.startContainer)return null;if((t=s.startContainer).type==CKEDITOR.NODE_TEXT&&s.startOffset)return t.getText()[s.startOffset-1];for(s.collapse(!0),s.setStartAt(this.editor.editable(),CKEDITOR.POSITION_AFTER_START),e=new CKEDITOR.dom.walker(s);i=e.previous();)if(i.type==CKEDITOR.NODE_TEXT)return i.getText().slice(-1);return null},bindClick:function(t){this.$doc.click(t)},unbindClick:function(t){this.$doc.off("click",t)},bindKeyup:function(){this.$doc.keyup(t.proxy(this.onKeyUp,this))},unbindKeyup:function(){this.$doc.off("keyup",this.onKeyUp)},focus:function(){this.editor.focus()},getContainer:function(){return this.$container}}),e}();return t(function(){var e,n;if("undefined"!=typeof CKEDITOR&&void 0!==CKEDITOR.instances){if(n=t.map(CKEDITOR.instances,function(t,e){return e})[0],"object"!=typeof CKEDITOR.instances[n])return!1;new g(n)}else if(null!==MyBBEditor&&"object"==typeof MyBBEditor&&MyBBEditor.getRangeHelper&&"function"==typeof MyBBEditor.getRangeHelper)new m;else if(t("#message").length>0||t("#signature").length>0){if(t("#message").length?e="message":t("#signature").length&&(e="signature"),!e||!t("#"+e).length)return!1;new f(e)}t(".quick_edit_button").click(i),t("#quick_reply_submit").click(s)}),e.autoComplete={setup:function(e){t.extend(c,e.lang||{}),delete e.lang,t.extend(r,e||{}),t(["minLength","maxLength","maxItems","fullText","showAvatars","lockSelection"]).each(function(){r[this]=a(r[this])}),r.defaultAvatar=r.imageDirectory+"/default_avatar.png"}},e}(jQuery,MentionMe||{});