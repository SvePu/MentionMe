/*
 * Plugin Name: MentionMe for MyBB 1.8.x
 * Copyright 2014 WildcardSearch
 * http://www.rantcentralforums.com
 *
 * this file contains a module for the auto-completion functionality
 */
var MentionMe=(function(e,o){
"use strict";
var b={minLength:3,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1,imageDirectory:"images"},t={instructions:"type a user name"},s={BACKSPACE:8,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},f=(function(){function z(T){var S,R,Q;this.editorInterface=T;Q=this.editorInterface.getContainer();this.$popup=e("#mentionme_master_popup").clone().attr("id","");this.$spinner=this.$popup.find("div.mentionme_spinner").hide();this.$input=this.$popup.find("input.mentionme_popup_input");this.$inputDiv=this.$popup.find("div.mentionme_popup_input_container");this.$body=this.$popup.find("div.mentionme_popup_body");if(typeof Q==="string"&&e("#"+Q).length){this.$container=e("#"+Q)}else{if(typeof Q==="object"&&e(Q).length){this.$container=e(Q)}else{return false}}this.$container.append(this.$popup);this.$popup.css({left:"-1000px",top:"-1000px"}).show();this.inputHeight=this.$inputDiv.height();S=e("<div/>");if(b.showAvatars){R=e("<img/>",{"class":"mention_user_avatar",src:b.defaultAvatar}).appendTo(S)}S.append(Array(b.maxLength+1).join("M")).addClass("mentionme_popup_item");this.$body.html(S);this.lineHeight=r(S.height())+this.editorInterface.lineHeightModifier+r(S.css("paddingTop").replace("px",""))+r(S.css("paddingBottom").replace("px",""));this.$instructions=e("<span/>",{"class":"mentionme_popup_instructions"}).html(t.instructions);this.scrollWidthDiff=this.$body.width()-this.$body[0].scrollWidth;this.keyCache=new l(this);this.nameCache=new k(this)}function N(R,Q){this.keyCache.clear();this.update();this.move(R,Q);this.$popup.show();this.lastSelected=null;this.select();this.visible=true;this.$body.mouseover(e.proxy(this.onMouseMove,this));this.$body.click(e.proxy(this.onClick,this));e(document).click(e.proxy(this.hide,this));this.editorInterface.bindClick(e.proxy(this.hide,this));this.$input.keydown(e.proxy(this.onKeyDown,this));this.$input.keyup(e.proxy(this.updateCheck,this));this.$input.click(e.proxy(this.onInputClick,this));this.$input.focus()}function D(){this.$popup.hide();this.$body.off("mouseover",this.onMouseMove);this.$body.off("click",this.onClick);e(document).off("click",this.hide);this.editorInterface.unbindClick(this.hide);this.$input.off("keydown",this.onKeyDown);this.$input.off("keyup",this.updateCheck);this.$input.off("click",this.onInputClick);this.visible=false;this.$input.val("")}function J(U,T){var S,R=this.nameCache.getLongestName(),Q;this.width=0;if(b.showAvatars){Q=e("<img/>",{"class":"mention_user_avatar",src:b.defaultAvatar}).css({left:"-1000px",top:"-1000px"}).appendTo(this.$container);this.width+=Q.width();Q.remove()}this.width+=r(this.$body.css("fontSize").replace("px","")*R);S={height:this.getCurrentHeight()+this.inputHeight+"px",width:r(this.width-this.scrollWidthDiff)+"px"};if(typeof U!="undefined"){S.left=U+"px"}if(typeof T!="undefined"){S.top=T+"px"}this.$popup.css(S);this.$body.css({height:this.getCurrentHeight()+"px",width:this.width})}function A(){if(!this.nameCache.isReady()){this.showSpinner();return}this.nameCache.match();this.buildItems();this.lastSelected=null;this.select();if(this.keyCache.getLength()>=b.minLength){this.nameCache.search()}}function O(){var S,V,R,Q,X,U=this.nameCache.getItemsLength(),T=this.nameCache.getData(),W=(navigator.userAgent.toLowerCase().indexOf("msie")!==-1)?"hand":"pointer";this.items=this.nameCache.getItems();if(U===0&&this.spinnerVisible==false){if(this.keyCache.getLength()>0){this.clear();this.$body.html(this.keyCache.getText())}else{this.showInstructions()}if(this.isVisible()){this.move()}return}this.clear();for(S=0;S<U;S++){V=T[this.items[S]]["username"];if(this.keyCache.getText()){X=this.items[S].indexOf(this.keyCache.getText());if((b.fullText&&X!==-1)||(!b.fullText&&X===0)){V=V.slice(0,X)+'<span class="mention_name_highlight">'+V.slice(X,X+this.keyCache.getLength())+"</span>"+V.slice(X+this.keyCache.getLength())}}R="";if(b.showAvatars){Q=T[this.items[S]]["avatar"];if(Q.length==0){Q=b.defaultAvatar}R=e("<img/>",{"class":"mention_user_avatar",src:Q}).one("error",function(){this.src=b.defaultAvatar})}this.$body.append(e("<div/>",{"class":"mentionme_popup_item mentionme_popup_item_"+S}).append(R).append(V).css({cursor:W}))}if(this.isVisible()){this.move()}}function I(){this.$body.html("");this.lastSelected=null;this.spinnerVisible=false;if(this.isVisible()){this.move()}}function x(){this.clear();this.$body.html(this.$spinner);this.spinnerVisible=true;if(this.isVisible()){this.move()}}function M(){this.clear();this.$body.html(this.$instructions)}function L(){if(this.keyCache.update()){this.update()}}function G(Q){var R=this.nameCache.getItemsLength()-1;switch(Q){case"last":this.selected=R;break;case"next":this.selected++;if(this.selected>R){this.selected=0}break;case"previous":this.selected--;if(this.selected<0){this.selected=R}break;case"nextPage":this.selected+=b.maxItems;if(this.selected>R){this.selected=R}break;case"previousPage":this.selected-=b.maxItems;if(this.selected<0){this.selected=0}break;default:this.selected=0;break}this.highlightSelected()}function P(S){var R=this.$popup.find(".mentionme_popup_item_"+this.selected),T=this.$popup.find(".mentionme_popup_item_"+this.lastSelected),Q=T.find("span.mention_name_highlight_on");if(this.lastSelected==this.selected||R.length==0){return}if(T.length){T.removeClass("mentionme_popup_item_on");if(Q.length){Q.removeClass("mention_name_highlight_on");Q.addClass("mention_name_highlight")}}this.lastSelected=this.selected;if(R){if(!R.hasClass("mentionme_popup_item_on")){R.addClass("mentionme_popup_item_on")}Q=R.find("span.mention_name_highlight");if(Q.length){Q.removeClass("mention_name_highlight");Q.addClass("mention_name_highlight_on")}}if(S!=true&&(this.nameCache.getItemsLength()-b.maxItems)>0){this.$body.prop("scrollTop",r(R.prop("offsetTop")-this.inputHeight))}}function u(Q){switch(Q.keyCode){case s.ENTER:this.editorInterface.insert();break;case s.UP:this.select("previous");break;case s.DOWN:this.select("next");break;case s.END:this.select("last");break;case s.HOME:this.select();break;case s.PAGE_UP:this.select("previousPage");break;case s.PAGE_DOWN:this.select("nextPage");break;case s.ESC:this.hide();break;case s.BACKSPACE:if(this.$input.val()===""){this.hide();this.editorInterface.focus()}return;break;default:return}Q.preventDefault()}function E(Q){if(this.selectEventTarget(Q)){this.highlightSelected(true)}}function y(Q){if(this.selectEventTarget(Q)){this.editorInterface.insert()}else{Q.preventDefault()}}function C(Q){Q.stopPropagation()}function H(V){if(!V){return false}var Q=e(V.target),S,T,U,R=false;if(Q.length==0||!Q.hasClass("mentionme_popup_item")){return}S=Q.prop("class").split(" ");while(T=S.shift()){if(typeof T!=="undefined"&&["mentionme_popup_item","mentionme_popup_item_on"].indexOf(T)===-1&&T.indexOf("mentionme_popup_item_")===0){R=true;break}}U=T.split("_");if(!R||!U||U.length==0||!U[U.length-1]){return false}this.selected=U[U.length-1];return true}function F(){if(this.nameCache.getItemsLength()===0||!this.items[this.selected]){return}return this.nameCache.getData()[this.items[this.selected]]["username"]}function m(){return(this.lineHeight*Math.max(1,Math.min(b.maxItems,this.nameCache.getItemsLength())))+this.editorInterface.heightModifier+4}function w(){return this.$input.val()}function B(){return this.lineHeight}function v(){return this.spinnerVisible}function K(){return this.visible}e.extend(z.prototype,{show:N,hide:D,move:J,update:A,buildItems:O,clear:I,showSpinner:x,showInstructions:M,updateCheck:L,select:G,highlightSelected:P,onKeyDown:u,onMouseMove:E,onClick:y,onInputClick:C,selectEventTarget:H,getSelectedName:F,getCurrentHeight:m,getInputValue:w,getLineHeight:B,spinnerIsVisible:v,isVisible:K});return z})(),l=(function(){function u(y){this.popup=y;this.clear()}function m(){this.data="";this.mirror=""}function x(){var y=false,z=this.popup.getInputValue();if(this.data!==z){y=true}this.data=z;return y}function w(){return this.data.length}function v(y){if(y!=true){return this.data.toLowerCase()}return this.data}e.extend(u.prototype,{clear:m,update:x,getLength:w,getText:v});return u})(),k=(function(){function z(F){this.data={};this.threadNames={};this.allNames={};this.ready=false;this.loading=true;this.searching=false;this.searched=[];this.items=[];this.longestName=5;this.popup=F;this.editorInterface=this.popup.editorInterface;this.keyCache=F.keyCache;e.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:b.tid},success:this.loadNameCache.bind(this)})}function u(F){this.ready=true;this.loading=false;this.threadNames=F.inThread;this.allNames=F.cached;e.extend(this.data,this.threadNames,this.allNames);if(e.isEmptyObject(this.data)){this.data={};this.popup.showInstructions();if(this.popup.isVisible()){this.popup.move()}return}if(this.popup.isVisible()){this.popup.update()}}function x(){var I,G=0,F={},H=[];this.items=[];this.longestName=5;for(I in this.threadNames){if(!this.checkEntry(I,this.threadNames,F)){continue}this.items.push(I);F[I]=true;G++}for(I in this.data){if(!this.checkEntry(I,this.data,F)){continue}H.push(I);F[I]=true;G++}H=H.sort(c);e.merge(this.items,H);return G}function A(H,G,F){if(!G.hasOwnProperty(H)||!G[H]||F[H]||(this.keyCache.getLength()&&((!b.fullText&&H.slice(0,this.keyCache.getLength())!==this.keyCache.getText())||(b.fullText&&H.indexOf(this.keyCache.getText())===-1)))){return false}if(H.length>this.longestName){this.longestName=H.length}return true}function E(){var F=this.keyCache.getText().slice(0,b.minLength);if(this.searching||this.searched.indexOf(F)!==-1){if(this.popup.spinnerIsVisible()){this.popup.hide();this.editorInterface.focus()}return}this.searched.push(F);this.searching=true;if(this.items.length===0){this.popup.showSpinner()}e.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:F},success:C.bind(this)})}function C(G){var H=0,F;this.searching=false;if(!G){if(this.popup.spinnerIsVisible()){this.popup.hide();this.editorInterface.focus()}return}for(F in G){if(!G.hasOwnProperty(F)||this.data[F]){continue}this.data[F]=G[F];H++}if(!H||!this.popup.isVisible()){return}this.match();this.popup.buildItems();this.popup.select()}function B(){return this.ready}function y(){return this.loading}function w(){return this.data}function v(){return this.items}function m(){return this.items.length}function D(){return this.longestName}e.extend(z.prototype,{loadNameCache:u,match:x,checkEntry:A,search:E,load:C,isReady:B,isLoading:y,getData:w,getItems:v,getItemsLength:m,getLongestName:D});return z})(),d=(function(){function m(F){this.$textarea=e("#"+F);this.$container=this.$textarea.closest("div");this.selection={start:0,end:0};this.popup=new f(this);this.bindKeyup()}function E(F){if(this.popup.isVisible()){return}this.getCaret();if(i(F.keyCode)&&this.$textarea.val().slice(this.selection.start-1,this.selection.end)=="@"){this.showPopup()}}function C(){var F=this.$textarea.caret("offset"),H=F.left+3,G=F.top-5;this.popup.show(H,G)}function u(){var F=p(this.popup);if(!F){if(!this.popup.spinnerIsVisible()){this.popup.hide()}return}this.getCaret();this.$textarea.val(this.$textarea.val().slice(0,this.selection.start)+F+this.$textarea.val().slice(this.selection.start));this.setCaret(this.selection.start+F.length);this.popup.hide()}function x(){var F=this.$textarea.caret("pos");this.selection.start=F;this.selection.end=F}function w(F){var H=this.$textarea[0],G;if(H.setSelectionRange){H.focus();H.setSelectionRange(F,F)}else{if(H.createTextRange){G=H.createTextRange();G.collapse(true);G.moveEnd("character",F);G.moveStart("character",F);G.select()}}}function z(F){this.$textarea.click(F)}function v(F){this.$textarea.off("click",F)}function B(){this.$textarea.keyup(e.proxy(this.onKeyUp,this))}function y(){this.$textarea.off("keyup")}function D(){this.$textarea.focus()}function A(){return this.$container}e.extend(m.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:E,showPopup:C,insert:u,getCaret:x,setCaret:w,bindClick:z,unbindClick:v,bindKeyup:B,unbindKeyup:y,focus:D,getContainer:A});return m})(),a=(function(){function w(){this.editor=MyBBEditor;this.rangeHelper=this.editor.getRangeHelper();this.$iFrame=e("iframe");this.$container=this.$iFrame.closest("td");this.$body=this.editor.getBody();this.selection={start:0,end:0};this.popup=new f(this);this.editor.keyUp(this.onKeyUp.bind(this))}function A(C){this.getCaret();if(!C.keyCode){if(C.originalEvent&&C.originalEvent.keyCode){C.keyCode=C.originalEvent.keyCode}else{return}}if(!this.popup.isVisible()){if(i(C.keyCode)&&this.$currentNode.text().slice(this.selection.start-1,this.selection.end)=="@"){this.showPopup()}return}}function z(){var E,G,F,D=this.$body.caret("offset",{iframe:this.$iFrame[0]}),C=this.$container.offset();E=7;if(this.$currentNode.closest("div").length&&typeof this.$currentNode.closest("div").css==="function"){E=r(this.$currentNode.closest("div").css("fontSize").replace("px","")/2)}G=r(D.left)+C.left+r(this.$container.css("paddingLeft").replace("px",""))+E+2;F=r(D.top+this.$container.find("div.sceditor-toolbar").height())+C.top+r(this.$container.css("paddingTop").replace("px",""))+3;this.popup.show(G,F)}function m(){var C=p(this.popup);if(!C){if(!this.popup.spinnerIsVisible()){this.popup.hide()}return}this.editor.insert(C);this.popup.hide()}function v(){var C=this.rangeHelper.selectedRange();if(C.startContainer){this.$currentNode=e(C.startContainer)}else{this.$currentNode=e(editor.currentNode())}this.selection.start=C.startOffset;this.selection.end=C.endOffset}function x(C){this.$body.click(C)}function u(C){this.$body.off("click",C)}function B(){this.$iFrame.focus()}function y(){return this.$container}e.extend(w.prototype,{heightModifier:0,lineHeightModifier:0,onKeyUp:A,showPopup:z,insert:m,getCaret:v,bindClick:x,unbindClick:u,focus:B,getContainer:y});return w})(),j=(function(){function m(G){if(e("#"+G).length===0||typeof CKEDITOR.instances[G]==="undefined"){return}this.id=G;this.editor=CKEDITOR.instances[this.id];if(G==="message"||G==="signature"){this.editor.on("instanceReady",e.proxy(this.finalize,this))}else{this.finalize()}e("#quick_reply_submit").click(e.proxy(this.quickReplyPosted,this))}function C(){this.$iFrame=e("#cke_"+this.id).find("iframe");this.$container=this.$iFrame.closest("div");this.$doc=e(this.editor.document.$);this.$body=this.$doc.find("body");this.bindKeyup();this.popup=new f(this)}function F(G){if(!this.popup.isVisible()){if(i(G.keyCode)&&this.getPrevChar()=="@"){this.showPopup()}return}}function w(){if(typeof this.$doc!=="undefined"&&this.$doc.length){this.$doc.off("keyup",this.onKeyUp)}setTimeout(e.proxy(function(){this.$doc.keyup(e.proxy(this.onKeyUp,this))},this),500)}function D(){var G=this.$body.caret("offset",{iframe:this.$iFrame[0]}),J=this.$iFrame.offset(),I=r(G.left+J.left)+2,H=r(G.top+J.top)-5;this.popup.show(I,H)}function v(){var G=p(this.popup);if(!G){if(!this.popup.spinnerIsVisible()){this.popup.hide()}return}this.editor.insertText(G);this.popup.hide()}function y(){var H,J,I,G=this.editor.getSelection().getRanges()[0];if(!G||!G.startContainer){return null}H=G.startContainer;if(H.type==CKEDITOR.NODE_TEXT&&G.startOffset){return H.getText()[G.startOffset-1]}else{G.collapse(true);G.setStartAt(this.editor.editable(),CKEDITOR.POSITION_AFTER_START);J=new CKEDITOR.dom.walker(G);while(I=J.previous()){if(I.type==CKEDITOR.NODE_TEXT){return I.getText().slice(-1)}}}return null}function z(G){this.$doc.click(G)}function u(G){this.$doc.off("click",G)}function B(){this.$doc.keyup(e.proxy(this.onKeyUp,this))}function x(){this.$doc.off("keyup",this.onKeyUp)}function E(){this.editor.focus()}function A(){return this.$container}e.extend(m.prototype,{heightModifier:0,lineHeightModifier:0,finalize:C,onKeyUp:F,quickReplyPosted:w,showPopup:D,insert:v,getPrevChar:y,bindClick:z,unbindClick:u,bindKeyup:B,unbindKeyup:x,focus:E,getContainer:A});return m})();function n(m){e.extend(t,m.lang||{});delete m.lang;e.extend(b,m||{});e(["minLength","maxLength","maxItems","fullText","showAvatars"]).each(function(){b[this]=r(b[this])});b.defaultAvatar=b.imageDirectory+"/default_avatar.png"}function q(){var u,m;if(typeof CKEDITOR!=="undefined"&&typeof CKEDITOR.instances!=="undefined"){m=e.map(CKEDITOR.instances,function(w,v){return v})[0];if(typeof CKEDITOR.instances[m]!=="object"){return false}new j(m)}else{if(MyBBEditor!==null&&typeof MyBBEditor==="object"&&MyBBEditor.getRangeHelper&&typeof MyBBEditor.getRangeHelper==="function"){new a()}else{if(e("#message").length>0||e("#signature").length>0){if(e("#message").length){u="message"}else{if(e("#signature").length){u="signature"}}if(!u||!e("#"+u).length){return false}new d(u)}}}e(".quick_edit_button").click(g);e("#quick_reply_submit").click(h)}function g(v){var m=this.id.split("_").slice(-1)[0],w="quickedit_"+m,u;if(e("#"+w).length==0){return}if(typeof CKEDITOR==="undefined"){u=new d(w)}else{setTimeout(function(){u=new j(w)},1100)}setTimeout(function(){e("#quicksub_"+m).add(e("#quicksub_"+m).next("button")).click(function(){u.unbindKeyup()})},1100)}function h(m){e(".quick_edit_button").off("click",g);setTimeout(function(){e(".quick_edit_button").click(g)},500)}function p(m){var v=m.getSelectedName(),u="";if(!v){return}if(v.indexOf('"')==-1){u='"'}else{if(v.indexOf("'")==-1){u="'"}else{if(v.indexOf("`")==-1){u="`"}}}return u+v+u+" "}function i(m){return[s.LEFT,s.RIGHT,s.UP,s.DOWN,s.BACKSPACE,s.ESC,s.SHIFT,s.CTRL,s.ALT,s.ENTER,s.DELETE,s.INSERT,s.END,s.NUMLOCK].indexOf(m)===-1}function c(u,m){if(u.length<m.length){return -1}else{if(u.length>m.length){return 1}else{return 0}}}function r(m){return parseInt(m,10)}e(q);o.autoComplete={setup:n};return o})(jQuery,MentionMe||{});