var MentionMe=(function(f,n){var e={minLength:3,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1},s={instructions:"type a user name"},r={BACKSPACE:8,NEWLINE:10,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},d=(typeof Object.keys==="function")?Object.keys:(function(){var u=Object.prototype.hasOwnProperty,v=!({toString:null}).propertyIsEnumerable("toString"),t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],m=t.length;return function(y){if(typeof y!=="object"&&(typeof y!=="function"||y===null)){throw new TypeError("Object.keys called on non-object")}var w=[],z,x;for(z in y){if(u.call(y,z)){w.push(z)}}if(v){for(x=0;x<m;x++){if(u.call(y,t[x])){w.push(t[x])}}}return w}}()),b=(function(){var O=false,z=false,P=0,ad=null,m=0,J,D=0,J,Q,K=[],R=[],w,x,L,T,aa,S;function ac(){var ah,ag,af=q.getContainer();x=f("#mentionme_popup");L=f("#mentionme_spinner").hide();T=f("#mentionme_popup_input");aa=f("#mentionme_popup_input_container");S=f("#mentionme_popup_body");if(typeof af==="string"&&f("#"+af)){w=f("#"+af)}else{if(typeof af==="object"&&f(af).length){w=f(af)}else{return false}}w.append(x);x.css({left:"-1000px",top:"-1000px"}).show();J=aa.height();ah=f("<div/>");if(e.showAvatars){ag=f("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).appendTo(ah)}ah.append(Array(e.maxLength+1).join("M")).addClass("mentionme_popup_item");S.html(ah);Q=parseInt(ah.height())+q.lineHeightModifier+parseInt(ah.css("paddingTop").replace("px",""))+parseInt(ah.css("paddingBottom").replace("px",""));D=S.width()-S[0].scrollWidth}function V(ag,af){if(!i.isReady()&&!i.isLoading()){i.init()}j.init();U();H(ag,af);x.show();ad=null;Y();O=true;S.mouseover(t);S.click(N);f(document).click(Z);q.bindClick(Z);T.keydown(A);T.keyup(B);T.click(E);T.focus()}function Z(){x.hide();S.unbind("mouseover",t);S.unbind("click",N);f(document).unbind("click",Z);q.unBindClick(Z);T.unbind("keydown",A);T.unbind("keyup",B);T.unbind("click",E);O=false;T.val("");q.focus()}function H(aj,ai){var ah,ag=i.getLongestName(),af;m=0;if(e.showAvatars){af=f("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).css({left:"-1000px",top:"-1000px"}).appendTo(w);m+=af.width();af.remove()}m+=parseInt(S.css("fontSize").replace("px","")*ag);ah={height:G()+J+"px",width:parseInt(m-D)+"px"};if(typeof aj!="undefined"){ah.left=aj+"px"}if(typeof ai!="undefined"){ah.top=ai+"px"}x.css(ah);S.css({height:G()+"px",width:m})}function U(){if(!i.isReady()){ae();return}i.match();M();ad=null;Y();if(j.getLength()>=e.minLength){i.search()}}function M(){var ag,ai,af,ak,ah=i.getItemsLength(),aj=(navigator.userAgent.toLowerCase().indexOf("msie")!==-1)?"hand":"pointer";K=i.getItems();R=i.getAvatars();if(ah===0&&z==false){if(j.getLength()>0){W();S.html(j.getText())}else{ab()}if(v()){H()}return}W();for(ag=0;ag<ah;ag++){ai=K[ag];if(j.getText()){ak=K[ag].toLowerCase().indexOf(j.getText());if((e.fullText&&ak!==-1)||(!e.fullText&&ak===0)){ai=K[ag].slice(0,ak)+'<span class="mention_name_highlight">'+K[ag].slice(ak,ak+j.getText().length)+"</span>"+K[ag].slice(ak+j.getText().length)}}af="";if(e.showAvatars){if(!R[ag]){R[ag]="images/default_avatar.png"}af='<img class="mention_user_avatar" src="'+R[ag]+'" />'}S.append(f("<div/>",{id:"mentionme_popup_item_"+ag,"class":"mentionme_popup_item"}).html(af+ai).css({cursor:aj}))}if(v()){H()}}function W(){S.html("");ad=null;z=false;if(v()){H()}}function ae(){W();S.html(L);z=true;if(v()){H()}}function ab(){W();S.html('<span style="color: grey; font-style: italic;">'+s.instructions+"</span>")}function B(){if(j.update()){U()}}function Y(af){var ag=i.getItemsLength()-1;switch(af){case"last":P=ag;break;case"next":P++;if(P>ag){P=0}break;case"previous":P--;if(P<0){P=ag}break;case"nextPage":P+=e.maxItems;if(P>ag){P=ag}break;case"previousPage":P-=e.maxItems;if(P<0){P=0}break;default:P=0;break}u()}function u(ai){if(ad==P||f("#mentionme_popup_item_"+P).length===0){return}var ah=f("#mentionme_popup_item_"+P),ag=f("#mentionme_popup_item_"+ad),af=ag.find("span.mention_name_highlight_on");if(ag.length){ag.removeClass("mentionme_popup_item_on");if(af.length){af.removeClass("mention_name_highlight_on");af.addClass("mention_name_highlight")}}ad=P;if(ah){if(!ah.hasClass("mentionme_popup_item_on")){ah.addClass("mentionme_popup_item_on")}af=ah.find("span.mention_name_highlight");if(af.length){af.removeClass("mention_name_highlight");af.addClass("mention_name_highlight_on")}}if(ai!=true&&(i.getItemsLength()-e.maxItems)>0){S.prop("scrollTop",parseInt(ah.prop("offsetTop")-J))}}function A(af){switch(af.keyCode){case r.ENTER:q.insert();break;case r.UP:Y("previous");break;case r.DOWN:Y("next");break;case r.END:Y("last");break;case r.HOME:Y();break;case r.PAGE_UP:Y("previousPage");break;case r.PAGE_DOWN:Y("nextPage");break;case r.ESC:Z();break;case r.BACKSPACE:if(T.val()===""){Z()}return;break;default:return}af.preventDefault()}function t(af){if(I(af)){u(true)}}function N(af){if(I(af)){q.insert()}else{af.preventDefault()}}function E(af){af.stopPropagation()}function I(ah){if(!ah){return false}var af,ag=ah.target;try{if(!ag||!ag.id||ag.id=="mentionme_popup"||ag.id=="mentionme_spinner"){return false}}catch(ah){return false}af=ag.id.split("_");if(!af||af.length==0||!af[af.length-1]){return false}P=af[af.length-1];return true}function C(){if(i.getItemsLength()===0||!K[P]){return}return K[P]}function G(){return(Q*Math.max(1,Math.min(e.maxItems,i.getItemsLength())))+q.heightModifier+4}function X(){return T.val()}function y(){return Q}function F(){return z}function v(){return O}return{init:ac,show:V,hide:Z,move:H,update:U,buildItems:M,showSpinner:ae,showInstructions:ab,select:Y,getSelectedName:C,getCurrentHeight:G,getInputValue:X,getLineHeight:y,spinnerIsVisible:F,isVisible:v}})(),j=(function(){var u="",v="";function w(){u="";v=""}function x(){var y=false,z=b.getInputValue();if(u!==z){y=true}u=z;return y}function t(){return u.length}function m(y){if(y!=true){return u.toLowerCase()}return u}return{init:w,update:x,getLength:t,getText:m}})(),i=(function(){var N={},L={},D={},C=false,u=false,M=false,H=[],G=[],x=[],z=5;function K(){u=true;f.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:e.tid},success:y})}function y(P){C=true;u=false;L=P.inThread;D=P.cached;f.extend(N,L,D);if(N.length===0){N={};b.showInstructions();if(b.isVisible()){b.move()}return}if(b.isVisible()){b.update()}}function v(){var T,R=0,P={},V=[],S=[],U=[],Q=[];G=[];x=[];z=5;for(T in L){if(!F(T,L,P)){continue}if(T.length>z){z=T.length}V.push(L[T]["username"]);if(e.showAvatars){U.push(L[T]["avatar"])}P[T]=true;R++}f.merge(G,V);if(e.showAvatars){f.merge(x,U)}for(T in N){if(!F(T,N,P)){continue}if(T.length>z){z=T.length}S.push(N[T]["username"]);if(e.showAvatars){Q.push(N[T]["avatar"])}P[T]=true;R++}S=S.sort(B);f.merge(G,S);if(e.showAvatars){f.merge(x,Q)}return R}function B(Q,P){if(Q.length<P.length){return -1}else{if(Q.length>P.length){return 1}else{return 0}}}function F(R,Q,P){if(!Q.hasOwnProperty(R)||!Q[R]||P[R]||(j.getLength()&&((!e.fullText&&R.slice(0,j.getLength())!==j.getText())||(e.fullText&&R.indexOf(j.getText())===-1)))){return false}return true}function A(){var P=j.getText().slice(0,e.minLength);if(M||H.indexOf(P)!==-1){if(b.spinnerIsVisible()){b.hide()}return}H.push(P);M=true;if(G.length===0){b.showSpinner()}f.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:P},success:w})}function w(Q){var R=0,P;M=false;if(!Q){if(b.spinnerIsVisible()){b.hide()}return}for(P in Q){if(!Q.hasOwnProperty(P)||N[P]){continue}N[P]=Q[P];R++}if(!R||!b.isVisible()){return}v();b.buildItems();b.select()}function I(){return C}function J(){return u}function m(){return G}function t(){return x}function O(){return G.length}function E(){return z}return{init:K,match:v,search:A,isReady:I,isLoading:J,getItems:m,getAvatars:t,getItemsLength:O,getLongestName:E}})(),a=(function(){var x,C,B={start:0,end:0};function m(){if(f("#message").length==0&&f("#signature").length==0){return false}return true}function D(){var G;if(f("#message").length){G="message"}else{if(f("#signature").length){G="signature"}}if(!G||!f("#"+G).length){return false}x=f("#"+G);C=x.closest("div");b.init();x.keyup(F)}function F(G){v();if(!b.isVisible()){if(g(G.keyCode)&&x.val().slice(B.start-1,B.end)=="@"){A()}}}function A(){var G=x.caret("offset"),I=G.left+3,H=G.top-5;b.show(I,H)}function u(){var G=o();if(!G){if(!b.spinnerIsVisible()){b.hide()}return}v();x.val(x.val().slice(0,B.start)+G+x.val().slice(B.start));t(B.start+G.length);b.hide()}function v(){var G=x.caret("pos");B.start=G;B.end=G}function t(G){var I=x[0];if(I.setSelectionRange){I.focus();I.setSelectionRange(G,G)}else{if(I.createTextRange){var H=I.createTextRange();H.collapse(true);H.moveEnd("character",G);H.moveStart("character",G);H.select()}}}function y(G){x.click(G)}function w(G){x.unbind("click",G)}function E(){x.focus()}function z(){return C}return{init:D,check:m,heightModifier:0,lineHeightModifier:0,insert:u,bindClick:y,unBindClick:w,focus:E,getContainer:z}})(),l=(function(){var y,v,D={start:0,end:0},F,B,x,G;function m(){if(MyBBEditor===null||typeof MyBBEditor!=="object"||!MyBBEditor.getRangeHelper||typeof MyBBEditor.getRangeHelper!=="function"){return false}return true}function E(){var J;y=MyBBEditor;v=y.getRangeHelper();B=f("iframe");F=B.closest("div");x=y.getBody();y.keyUp(I);b.init()}function I(J){u();if(!J.keyCode){if(J.originalEvent&&J.originalEvent.keyCode){J.keyCode=J.originalEvent.keyCode}else{return}}if(!b.isVisible()){if(g(J.keyCode)&&G.text().slice(D.start-1,D.end)=="@"){C()}return}}function C(){var J=x.caret("offset",{iframe:B[0]}),L=parseInt(J.left)+7,K=parseInt(J.top+F.find("div.sceditor-toolbar").height())+2;b.show(L,K)}function t(){var J=o();if(!J){if(!b.spinnerIsVisible()){b.hide()}return}y.insert(J);b.hide()}function u(){var J=v.selectedRange();if(J.startContainer){G=f(J.startContainer)}else{G=f(y.currentNode())}D.start=J.startOffset;D.end=J.endOffset}function z(J){x.click(J)}function w(J){x.unbind("click",J)}function H(){B.focus()}function A(){return F}return{init:E,check:m,heightModifier:0,lineHeightModifier:0,insert:t,bindClick:z,unBindClick:w,focus:H,getContainer:A}})(),h=(function(){var y,J={start:0,end:0},D,H,z,C,x;function I(){if(typeof CKEDITOR==="undefined"||typeof CKEDITOR.instances==="undefined"||CKEDITOR.instances.length==0){return false}return true}function F(){var K=d(CKEDITOR.instances)[0];if(typeof CKEDITOR.instances[K]!=="object"){return false}y=CKEDITOR.instances[K];y.on("instanceReady",m)}function m(){H=f("iframe");D=H.closest("div");z=f(y.document.$);C=z.find("body");z.keyup(t);b.init()}function t(L){var K=true;if(!b.isVisible()){if(g(L.keyCode)&&G()=="@"){A()}return}}function A(){var K=C.caret("offset",{iframe:H[0]}),N=H.offset(),M=parseInt(K.left+N.left)+2,L=parseInt(K.top+N.top)-5;b.show(M,L)}function w(){var K=o();if(!K){if(!b.spinnerIsVisible()){b.hide()}return}y.insertText(K);b.hide()}function G(){var K=y.getSelection().getRanges()[0],L;if(!K||!K.startContainer){return null}L=K.startContainer;if(L.type==CKEDITOR.NODE_TEXT&&K.startOffset){return L.getText()[K.startOffset-1]}else{K.collapse(true);K.setStartAt(y.editable(),CKEDITOR.POSITION_AFTER_START);var N=new CKEDITOR.dom.walker(K),M;while((M=N.previous())){if(M.type==CKEDITOR.NODE_TEXT){return M.getText().slice(-1)}}}return null}function u(K){z.click(K)}function v(K){z.unbind("click",K)}function B(){y.focus()}function E(){return D}return{init:F,check:I,heightModifier:0,lineHeightModifier:0,insert:w,bindClick:u,unBindClick:v,focus:B,getContainer:E}})(),q=null;function k(m){f.extend(s,m.lang||{});delete m.lang;f.extend(e,m||{});f(["minLength","maxLength","maxItems","fullText","showAvatars"]).each(function(){e[this]=parseInt(e[this],10)})}function p(){if(h.check()){q=h}else{if(l.check()){q=l}else{if(a.check()){q=a}else{return}}}q.init()}function c(){var m;if(self.pageYOffset){m=self.pageYOffset}else{if(document.documentElement&&document.documentElement.scrollTop){m=document.documentElement.scrollTop}else{if(document.body){m=document.body.scrollTop}}}return new Array("",m)}function o(){var t=b.getSelectedName(),m="";if(!t){return}if(t.indexOf('"')==-1){m='"'}else{if(t.indexOf("'")==-1){m="'"}else{if(t.indexOf("`")==-1){m="`"}}}return m+t+m+" "}function g(m){return[r.LEFT,r.RIGHT,r.UP,r.DOWN,r.BACKSPACE,r.ESC,r.SHIFT,r.CTRL,r.ALT,r.ENTER,r.DELETE,r.INSERT,r.END,r.NUMLOCK].indexOf(m)===-1}f(p);n.autoComplete={setup:k};return n})(jQuery,MentionMe||{});