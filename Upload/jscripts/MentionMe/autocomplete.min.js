var MentionMe=(function(k,g){var q={minLength:3,maxLength:30,maxItems:5,tid:"",fullText:0,showAvatars:1},e={instructions:"type a user name"},o={BACKSPACE:8,NEWLINE:10,ENTER:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUMLOCK:144},b=(function(){var M=false,x=false,N=0,aa=null,m=0,B=0,H,O,I=[],u,v,J,Q,X,P;function Z(){var ae,ad,ac=f.getContainer();v=k("#mentionme_popup");J=k("#mentionme_spinner").hide();Q=k("#mentionme_popup_input");X=k("#mentionme_popup_input_container");P=k("#mentionme_popup_body");if(typeof ac==="string"&&k("#"+ac).length){u=k("#"+ac)}else{if(typeof ac==="object"&&k(ac).length){u=k(ac)}else{return false}}u.append(v);v.css({left:"-1000px",top:"-1000px"}).show();H=X.height();ae=k("<div/>");if(q.showAvatars){ad=k("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).appendTo(ae)}ae.append(Array(q.maxLength+1).join("M")).addClass("mentionme_popup_item");P.html(ae);O=parseInt(ae.height())+f.lineHeightModifier+parseInt(ae.css("paddingTop").replace("px",""))+parseInt(ae.css("paddingBottom").replace("px",""));B=P.width()-P[0].scrollWidth}function S(ad,ac){if(!a.isReady()&&!a.isLoading()){a.init()}n.init();R();F(ad,ac);v.show();aa=null;V();M=true;P.mouseover(r);P.click(L);k(document).click(W);f.bindClick(W);Q.keydown(y);Q.keyup(z);Q.click(C);Q.focus()}function W(){v.hide();P.unbind("mouseover",r);P.unbind("click",L);k(document).unbind("click",W);f.unBindClick(W);Q.unbind("keydown",y);Q.unbind("keyup",z);Q.unbind("click",C);M=false;Q.val("");f.focus()}function F(ag,af){var ae,ad=a.getLongestName(),ac;m=0;if(q.showAvatars){ac=k("<img/>",{"class":"mention_user_avatar",src:"images/default_avatar.png"}).css({left:"-1000px",top:"-1000px"}).appendTo(u);m+=ac.width();ac.remove()}m+=parseInt(P.css("fontSize").replace("px","")*ad);ae={height:E()+H+"px",width:parseInt(m-B)+"px"};if(typeof ag!="undefined"){ae.left=ag+"px"}if(typeof af!="undefined"){ae.top=af+"px"}v.css(ae);P.css({height:E()+"px",width:m})}function R(){if(!a.isReady()){ab();return}a.match();K();aa=null;V();if(n.getLength()>=q.minLength){a.search()}}function K(){var ae,ah,ad,ac,aj,ag=a.getItemsLength(),af=a.getData(),ai=(navigator.userAgent.toLowerCase().indexOf("msie")!==-1)?"hand":"pointer";I=a.getItems();if(ag===0&&x==false){if(n.getLength()>0){T();P.html(n.getText())}else{Y()}if(t()){F()}return}T();for(ae=0;ae<ag;ae++){ah=af[I[ae]]["username"];if(n.getText()){aj=I[ae].indexOf(n.getText());if((q.fullText&&aj!==-1)||(!q.fullText&&aj===0)){ah=ah.slice(0,aj)+'<span class="mention_name_highlight">'+ah.slice(aj,aj+n.getText().length)+"</span>"+ah.slice(aj+n.getText().length)}}ad="";if(q.showAvatars){ac=af[I[ae]]["avatar"];if(ac.length==0){ac="images/default_avatar.png"}ad='<img class="mention_user_avatar" src="'+ac+'" />'}P.append(k("<div/>",{id:"mentionme_popup_item_"+ae,"class":"mentionme_popup_item"}).html(ad+ah).css({cursor:ai}))}if(t()){F()}}function T(){P.html("");aa=null;x=false;if(t()){F()}}function ab(){T();P.html(J);x=true;if(t()){F()}}function Y(){T();P.html('<span style="color: grey; font-style: italic;">'+e.instructions+"</span>")}function z(){if(n.update()){R()}}function V(ac){var ad=a.getItemsLength()-1;switch(ac){case"last":N=ad;break;case"next":N++;if(N>ad){N=0}break;case"previous":N--;if(N<0){N=ad}break;case"nextPage":N+=q.maxItems;if(N>ad){N=ad}break;case"previousPage":N-=q.maxItems;if(N<0){N=0}break;default:N=0;break}s()}function s(af){if(aa==N||k("#mentionme_popup_item_"+N).length===0){return}var ae=k("#mentionme_popup_item_"+N),ad=k("#mentionme_popup_item_"+aa),ac=ad.find("span.mention_name_highlight_on");if(ad.length){ad.removeClass("mentionme_popup_item_on");if(ac.length){ac.removeClass("mention_name_highlight_on");ac.addClass("mention_name_highlight")}}aa=N;if(ae){if(!ae.hasClass("mentionme_popup_item_on")){ae.addClass("mentionme_popup_item_on")}ac=ae.find("span.mention_name_highlight");if(ac.length){ac.removeClass("mention_name_highlight");ac.addClass("mention_name_highlight_on")}}if(af!=true&&(a.getItemsLength()-q.maxItems)>0){P.prop("scrollTop",parseInt(ae.prop("offsetTop")-H))}}function y(ac){switch(ac.keyCode){case o.ENTER:f.insert();break;case o.UP:V("previous");break;case o.DOWN:V("next");break;case o.END:V("last");break;case o.HOME:V();break;case o.PAGE_UP:V("previousPage");break;case o.PAGE_DOWN:V("nextPage");break;case o.ESC:W();break;case o.BACKSPACE:if(Q.val()===""){W()}return;break;default:return}ac.preventDefault()}function r(ac){if(G(ac)){s(true)}}function L(ac){if(G(ac)){f.insert()}else{ac.preventDefault()}}function C(ac){ac.stopPropagation()}function G(ae){if(!ae){return false}var ac,ad=ae.target;try{if(!ad||!ad.id||ad.id=="mentionme_popup"||ad.id=="mentionme_spinner"){return false}}catch(ae){return false}ac=ad.id.split("_");if(!ac||ac.length==0||!ac[ac.length-1]){return false}N=ac[ac.length-1];return true}function A(){if(a.getItemsLength()===0||!I[N]){return}return I[N]}function E(){return(O*Math.max(1,Math.min(q.maxItems,a.getItemsLength())))+f.heightModifier+4}function U(){return Q.val()}function w(){return O}function D(){return x}function t(){return M}return{init:Z,show:S,hide:W,move:F,update:R,buildItems:K,showSpinner:ab,showInstructions:Y,select:V,getSelectedName:A,getCurrentHeight:E,getInputValue:U,getLineHeight:w,spinnerIsVisible:D,isVisible:t}})(),n=(function(){var s="",t="";function u(){s="";t=""}function v(){var w=false,x=b.getInputValue();if(s!==x){w=true}s=x;return w}function r(){return s.length}function m(w){if(w!=true){return s.toLowerCase()}return s}return{init:u,update:v,getLength:r,getText:m}})(),a=(function(){var K={},I={},A={},z=false,r=false,J=false,E=[],D=[],v=5;function H(){r=true;k.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"getNameCache",tid:q.tid},success:u})}function u(M){z=true;r=false;I=M.inThread;A=M.cached;k.extend(K,I,A);if(K.length===0){K={};b.showInstructions();if(b.isVisible()){b.move()}return}if(b.isVisible()){b.update()}}function s(){var P,N=0,M={},O=[];D=[];v=5;for(P in I){if(!C(P,I,M)){continue}if(P.length>v){v=P.length}D.push(P);M[P]=true;N++}for(P in K){if(!C(P,K,M)){continue}if(P.length>v){v=P.length}O.push(P);M[P]=true;N++}O=O.sort(x);k.merge(D,O);return N}function x(N,M){if(N.length<M.length){return -1}else{if(N.length>M.length){return 1}else{return 0}}}function C(O,N,M){if(!N.hasOwnProperty(O)||!N[O]||M[O]||(n.getLength()&&((!q.fullText&&O.slice(0,n.getLength())!==n.getText())||(q.fullText&&O.indexOf(n.getText())===-1)))){return false}return true}function w(){var M=n.getText().slice(0,q.minLength);if(J||E.indexOf(M)!==-1){if(b.spinnerIsVisible()){b.hide()}return}E.push(M);J=true;if(D.length===0){b.showSpinner()}k.ajax({type:"post",url:"xmlhttp.php",data:{action:"mentionme",mode:"nameSearch",search:M},success:t})}function t(N){var O=0,M;J=false;if(!N){if(b.spinnerIsVisible()){b.hide()}return}for(M in N){if(!N.hasOwnProperty(M)||K[M]){continue}K[M]=N[M];O++}if(!O||!b.isVisible()){return}s();b.buildItems();b.select()}function F(){return z}function G(){return r}function y(){return K}function m(){return D}function L(){return D.length}function B(){return v}return{init:H,match:s,search:w,isReady:F,isLoading:G,getData:y,getItems:m,getItemsLength:L,getLongestName:B}})(),j=(function(){var v,A,z={start:0,end:0};function m(){if(k("#message").length==0&&k("#signature").length==0){return false}return true}function B(){var E;if(k("#message").length){E="message"}else{if(k("#signature").length){E="signature"}}if(!E||!k("#"+E).length){return false}v=k("#"+E);A=v.closest("div");b.init();v.keyup(D)}function D(E){t();if(!b.isVisible()){if(c(E.keyCode)&&v.val().slice(z.start-1,z.end)=="@"){y()}}}function y(){var E=v.caret("offset"),G=E.left+3,F=E.top-5;b.show(G,F)}function s(){var E=i();if(!E){if(!b.spinnerIsVisible()){b.hide()}return}t();v.val(v.val().slice(0,z.start)+E+v.val().slice(z.start));r(z.start+E.length);b.hide()}function t(){var E=v.caret("pos");z.start=E;z.end=E}function r(E){var G=v[0],F;if(G.setSelectionRange){G.focus();G.setSelectionRange(E,E)}else{if(G.createTextRange){F=G.createTextRange();F.collapse(true);F.moveEnd("character",E);F.moveStart("character",E);F.select()}}}function w(E){v.click(E)}function u(E){v.unbind("click",E)}function C(){v.focus()}function x(){return A}return{init:B,check:m,heightModifier:0,lineHeightModifier:0,insert:s,bindClick:w,unBindClick:u,focus:C,getContainer:x}})(),l=(function(){var w,t,B={start:0,end:0},D,z,v,E;function m(){if(MyBBEditor===null||typeof MyBBEditor!=="object"||!MyBBEditor.getRangeHelper||typeof MyBBEditor.getRangeHelper!=="function"){return false}return true}function C(){w=MyBBEditor;t=w.getRangeHelper();z=k("iframe");D=z.closest("div");v=w.getBody();w.keyUp(G);b.init()}function G(H){s();if(!H.keyCode){if(H.originalEvent&&H.originalEvent.keyCode){H.keyCode=H.originalEvent.keyCode}else{return}}if(!b.isVisible()){if(c(H.keyCode)&&E.text().slice(B.start-1,B.end)=="@"){A()}return}}function A(){var H=v.caret("offset",{iframe:z[0]}),J=parseInt(H.left)+7,I=parseInt(H.top+D.find("div.sceditor-toolbar").height())+2;b.show(J,I)}function r(){var H=i();if(!H){if(!b.spinnerIsVisible()){b.hide()}return}w.insert(H);b.hide()}function s(){var H=t.selectedRange();if(H.startContainer){E=k(H.startContainer)}else{E=k(w.currentNode())}B.start=H.startOffset;B.end=H.endOffset}function x(H){v.click(H)}function u(H){v.unbind("click",H)}function F(){z.focus()}function y(){return D}return{init:C,check:m,heightModifier:0,lineHeightModifier:0,insert:r,bindClick:x,unBindClick:u,focus:F,getContainer:y}})(),d=(function(){var w,C,A,v,u;function m(){if(typeof CKEDITOR==="undefined"||typeof CKEDITOR.instances==="undefined"||CKEDITOR.instances.length==0){return false}return true}function D(){var G=k.map(CKEDITOR.instances,function(I,H){return H})[0];if(typeof CKEDITOR.instances[G]!=="object"){return false}w=CKEDITOR.instances[G];w.on("instanceReady",z)}function z(){A=k("iframe");C=A.closest("div");v=k(w.document.$);u=v.find("body");v.keyup(F);b.init()}function F(G){if(!b.isVisible()){if(c(G.keyCode)&&t()=="@"){B()}return}}function B(){var G=u.caret("offset",{iframe:A[0]}),J=A.offset(),I=parseInt(G.left+J.left)+2,H=parseInt(G.top+J.top)-5;b.show(I,H)}function r(){var G=i();if(!G){if(!b.spinnerIsVisible()){b.hide()}return}w.insertText(G);b.hide()}function t(){var G=w.getSelection().getRanges()[0],H,J,I;if(!G||!G.startContainer){return null}H=G.startContainer;if(H.type==CKEDITOR.NODE_TEXT&&G.startOffset){return H.getText()[G.startOffset-1]}else{G.collapse(true);G.setStartAt(w.editable(),CKEDITOR.POSITION_AFTER_START);J=new CKEDITOR.dom.walker(G);while(I=J.previous()){if(I.type==CKEDITOR.NODE_TEXT){return I.getText().slice(-1)}}}return null}function x(G){v.click(G)}function s(G){v.unbind("click",G)}function E(){w.focus()}function y(){return C}return{init:D,check:m,heightModifier:0,lineHeightModifier:0,insert:r,bindClick:x,unBindClick:s,focus:E,getContainer:y}})(),f=null;function h(m){k.extend(e,m.lang||{});delete m.lang;k.extend(q,m||{});k(["minLength","maxLength","maxItems","fullText","showAvatars"]).each(function(){q[this]=parseInt(q[this],10)})}function p(){if(d.check()){f=d}else{if(l.check()){f=l}else{if(j.check()){f=j}else{return}}}f.init()}function i(){var r=b.getSelectedName(),m="";if(!r){return}if(r.indexOf('"')==-1){m='"'}else{if(r.indexOf("'")==-1){m="'"}else{if(r.indexOf("`")==-1){m="`"}}}return m+r+m+" "}function c(m){return[o.LEFT,o.RIGHT,o.UP,o.DOWN,o.BACKSPACE,o.ESC,o.SHIFT,o.CTRL,o.ALT,o.ENTER,o.DELETE,o.INSERT,o.END,o.NUMLOCK].indexOf(m)===-1}k(p);g.autoComplete={setup:h};return g})(jQuery,MentionMe||{});